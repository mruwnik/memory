"""Complete database schema.

This migration creates all tables from scratch. It was generated by squashing
all previous migrations into a single base migration.

For existing databases, this migration is skipped (they have 20260131_150000).
For fresh databases, this creates the complete schema.

Revision ID: 20260131_000000
Revises:
Create Date: 2026-01-31

"""
from typing import Sequence, Union

from alembic import op
import sqlalchemy as sa
from sqlalchemy.dialects import postgresql

# revision identifiers, used by Alembic.
revision: str = '20260131_000000'
down_revision: Union[str, None] = None
branch_labels: Union[str, Sequence[str], None] = None
depends_on: Union[str, Sequence[str], None] = None


def upgrade() -> None:
    # Create required extensions
    op.execute("CREATE EXTENSION IF NOT EXISTS pgcrypto")
    op.execute('CREATE EXTENSION IF NOT EXISTS "uuid-ossp"')

    # ### commands auto generated by Alembic - please adjust! ###
    op.create_table('belief_cluster',
    sa.Column('id', sa.BigInteger(), nullable=False),
    sa.Column('cluster_name', sa.Text(), nullable=False),
    sa.Column('core_beliefs', sa.ARRAY(sa.Text()), nullable=False),
    sa.Column('peripheral_beliefs', sa.ARRAY(sa.Text()), nullable=True),
    sa.Column('internal_consistency', sa.Numeric(precision=3, scale=2), nullable=True),
    sa.Column('supporting_observations', sa.ARRAY(sa.BigInteger()), nullable=True),
    sa.Column('created_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=True),
    sa.Column('last_updated', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=True),
    sa.Column('cluster_metadata', postgresql.JSONB(astext_type=sa.Text()), nullable=True),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_index('belief_cluster_consistency_idx', 'belief_cluster', ['internal_consistency'], unique=False)
    op.create_index('belief_cluster_name_idx', 'belief_cluster', ['cluster_name'], unique=False)
    op.create_table('book',
    sa.Column('id', sa.BigInteger(), nullable=False),
    sa.Column('isbn', sa.Text(), nullable=True),
    sa.Column('title', sa.Text(), nullable=False),
    sa.Column('author', sa.Text(), nullable=True),
    sa.Column('publisher', sa.Text(), nullable=True),
    sa.Column('published', sa.DateTime(timezone=True), nullable=True),
    sa.Column('language', sa.Text(), nullable=True),
    sa.Column('edition', sa.Text(), nullable=True),
    sa.Column('series', sa.Text(), nullable=True),
    sa.Column('series_number', sa.Integer(), nullable=True),
    sa.Column('total_pages', sa.Integer(), nullable=True),
    sa.Column('file_path', sa.Text(), nullable=True),
    sa.Column('tags', sa.ARRAY(sa.Text()), server_default='{}', nullable=False),
    sa.Column('metadata', postgresql.JSONB(astext_type=sa.Text()), nullable=True),
    sa.Column('created_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=True),
    sa.PrimaryKeyConstraint('id'),
    sa.UniqueConstraint('isbn')
    )
    op.create_index('book_author_idx', 'book', ['author'], unique=False)
    op.create_index('book_isbn_idx', 'book', ['isbn'], unique=False)
    op.create_index('book_title_idx', 'book', ['title'], unique=False)
    op.create_table('conversation_metrics',
    sa.Column('id', sa.BigInteger(), nullable=False),
    sa.Column('session_id', sa.UUID(), nullable=False),
    sa.Column('depth_score', sa.Numeric(precision=3, scale=2), nullable=True),
    sa.Column('breakthrough_count', sa.Integer(), nullable=True),
    sa.Column('challenge_acceptance', sa.Numeric(precision=3, scale=2), nullable=True),
    sa.Column('new_insights', sa.Integer(), nullable=True),
    sa.Column('user_engagement', sa.Numeric(precision=3, scale=2), nullable=True),
    sa.Column('duration_minutes', sa.Integer(), nullable=True),
    sa.Column('observation_count', sa.Integer(), nullable=True),
    sa.Column('contradiction_count', sa.Integer(), nullable=True),
    sa.Column('created_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=True),
    sa.Column('metrics_metadata', postgresql.JSONB(astext_type=sa.Text()), nullable=True),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_index('conv_metrics_breakthrough_idx', 'conversation_metrics', ['breakthrough_count'], unique=False)
    op.create_index('conv_metrics_depth_idx', 'conversation_metrics', ['depth_score'], unique=False)
    op.create_index('conv_metrics_session_idx', 'conversation_metrics', ['session_id'], unique=True)
    op.create_table('discord_bots',
    sa.Column('id', sa.BigInteger(), nullable=False),
    sa.Column('name', sa.Text(), nullable=False),
    sa.Column('token_encrypted', sa.LargeBinary(), nullable=True),
    sa.Column('is_active', sa.Boolean(), nullable=False),
    sa.Column('created_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=True),
    sa.Column('updated_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=True),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_table('google_oauth_config',
    sa.Column('id', sa.BigInteger(), nullable=False),
    sa.Column('name', sa.Text(), nullable=False),
    sa.Column('client_id', sa.Text(), nullable=False),
    sa.Column('client_secret', sa.Text(), nullable=False),
    sa.Column('project_id', sa.Text(), nullable=True),
    sa.Column('auth_uri', sa.Text(), server_default='https://accounts.google.com/o/oauth2/auth', nullable=False),
    sa.Column('token_uri', sa.Text(), server_default='https://oauth2.googleapis.com/token', nullable=False),
    sa.Column('redirect_uris', sa.ARRAY(sa.Text()), server_default='{}', nullable=False),
    sa.Column('javascript_origins', sa.ARRAY(sa.Text()), server_default='{}', nullable=False),
    sa.Column('created_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False),
    sa.Column('updated_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False),
    sa.PrimaryKeyConstraint('id'),
    sa.UniqueConstraint('name')
    )
    op.create_table('mcp_servers',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('name', sa.Text(), nullable=False),
    sa.Column('mcp_server_url', sa.Text(), nullable=False),
    sa.Column('client_id', sa.Text(), nullable=False),
    sa.Column('available_tools', sa.ARRAY(sa.Text()), server_default='{}', nullable=False),
    sa.Column('disabled_tools', sa.ARRAY(sa.Text()), server_default='{}', nullable=False),
    sa.Column('state', sa.Text(), nullable=True),
    sa.Column('code_verifier', sa.Text(), nullable=True),
    sa.Column('access_token', sa.Text(), nullable=True),
    sa.Column('refresh_token', sa.Text(), nullable=True),
    sa.Column('token_expires_at', sa.DateTime(timezone=True), nullable=True),
    sa.Column('created_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=True),
    sa.Column('updated_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=True),
    sa.PrimaryKeyConstraint('id'),
    sa.UniqueConstraint('state')
    )
    op.create_index('mcp_state_idx', 'mcp_servers', ['state'], unique=False)
    op.create_table('metric_events',
    sa.Column('id', sa.BigInteger(), autoincrement=True, nullable=False),
    sa.Column('timestamp', sa.DateTime(timezone=True), nullable=False),
    sa.Column('metric_type', sa.String(length=50), nullable=False),
    sa.Column('name', sa.String(length=200), nullable=False),
    sa.Column('duration_ms', sa.Float(), nullable=True),
    sa.Column('status', sa.String(length=50), nullable=True),
    sa.Column('labels', postgresql.JSONB(astext_type=sa.Text()), nullable=False),
    sa.Column('value', sa.Float(), nullable=True),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_index('idx_metric_events_timestamp', 'metric_events', ['timestamp'], unique=False)
    op.create_index('idx_metric_events_timestamp_type', 'metric_events', ['timestamp', 'metric_type'], unique=False)
    op.create_index('idx_metric_events_type_name', 'metric_events', ['metric_type', 'name'], unique=False)
    op.create_table('oauth_client',
    sa.Column('client_id', sa.String(), nullable=False),
    sa.Column('client_secret', sa.String(), nullable=True),
    sa.Column('client_id_issued_at', sa.Numeric(), nullable=False),
    sa.Column('client_secret_expires_at', sa.Numeric(), nullable=True),
    sa.Column('redirect_uris', sa.ARRAY(sa.String()), nullable=False),
    sa.Column('token_endpoint_auth_method', sa.String(), nullable=False),
    sa.Column('grant_types', sa.ARRAY(sa.String()), nullable=False),
    sa.Column('response_types', sa.ARRAY(sa.String()), nullable=False),
    sa.Column('scope', sa.String(), nullable=False),
    sa.Column('client_name', sa.String(), nullable=False),
    sa.Column('client_uri', sa.String(), nullable=True),
    sa.Column('logo_uri', sa.String(), nullable=True),
    sa.Column('contacts', sa.ARRAY(sa.String()), nullable=True),
    sa.Column('tos_uri', sa.String(), nullable=True),
    sa.Column('policy_uri', sa.String(), nullable=True),
    sa.Column('jwks_uri', sa.String(), nullable=True),
    sa.PrimaryKeyConstraint('client_id')
    )
    op.create_table('observation_pattern',
    sa.Column('id', sa.BigInteger(), nullable=False),
    sa.Column('pattern_type', sa.Text(), nullable=False),
    sa.Column('description', sa.Text(), nullable=False),
    sa.Column('supporting_observations', sa.ARRAY(sa.BigInteger()), nullable=False),
    sa.Column('exceptions', sa.ARRAY(sa.BigInteger()), nullable=True),
    sa.Column('confidence', sa.Numeric(precision=3, scale=2), nullable=False),
    sa.Column('validity_start', sa.DateTime(timezone=True), nullable=True),
    sa.Column('validity_end', sa.DateTime(timezone=True), nullable=True),
    sa.Column('created_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=True),
    sa.Column('updated_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=True),
    sa.Column('pattern_metadata', postgresql.JSONB(astext_type=sa.Text()), nullable=True),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_index('obs_pattern_confidence_idx', 'observation_pattern', ['confidence'], unique=False)
    op.create_index('obs_pattern_type_idx', 'observation_pattern', ['pattern_type'], unique=False)
    op.create_index('obs_pattern_validity_idx', 'observation_pattern', ['validity_start', 'validity_end'], unique=False)
    op.create_table('reaction_pattern',
    sa.Column('id', sa.BigInteger(), nullable=False),
    sa.Column('trigger_type', sa.Text(), nullable=False),
    sa.Column('reaction_type', sa.Text(), nullable=False),
    sa.Column('frequency', sa.Numeric(precision=3, scale=2), nullable=False),
    sa.Column('first_observed', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=True),
    sa.Column('last_observed', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=True),
    sa.Column('example_observations', sa.ARRAY(sa.BigInteger()), nullable=True),
    sa.Column('reaction_metadata', postgresql.JSONB(astext_type=sa.Text()), nullable=True),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_index('reaction_frequency_idx', 'reaction_pattern', ['frequency'], unique=False)
    op.create_index('reaction_trigger_idx', 'reaction_pattern', ['trigger_type'], unique=False)
    op.create_index('reaction_type_idx', 'reaction_pattern', ['reaction_type'], unique=False)
    op.create_table('users',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('name', sa.String(), nullable=False),
    sa.Column('email', sa.String(), nullable=False),
    sa.Column('user_type', sa.String(), nullable=False),
    sa.Column('password_hash', sa.String(), nullable=True),
    sa.Column('api_key', sa.String(), nullable=True),
    sa.Column('scopes', sa.ARRAY(sa.String()), nullable=False),
    sa.Column('ssh_public_key', sa.String(), nullable=True),
    sa.Column('ssh_private_key_encrypted', sa.LargeBinary(), nullable=True),
    sa.CheckConstraint('password_hash IS NOT NULL OR api_key IS NOT NULL', name='user_has_auth_method'),
    sa.PrimaryKeyConstraint('id'),
    sa.UniqueConstraint('api_key'),
    sa.UniqueConstraint('email')
    )
    op.create_table('api_keys',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('user_id', sa.Integer(), nullable=False),
    sa.Column('key', sa.String(), nullable=False),
    sa.Column('name', sa.String(), nullable=True),
    sa.Column('key_type', sa.String(), nullable=False),
    sa.Column('scopes', sa.ARRAY(sa.String()), nullable=True),
    sa.Column('created_at', sa.DateTime(), server_default=sa.text('now()'), nullable=True),
    sa.Column('expires_at', sa.DateTime(), nullable=True),
    sa.Column('last_used_at', sa.DateTime(), nullable=True),
    sa.Column('revoked', sa.Boolean(), nullable=False),
    sa.ForeignKeyConstraint(['user_id'], ['users.id'], ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('id'),
    sa.UniqueConstraint('key')
    )
    op.create_table('availability_polls',
    sa.Column('id', sa.BigInteger(), autoincrement=True, nullable=False),
    sa.Column('slug', sa.String(length=20), nullable=False),
    sa.Column('title', sa.String(length=255), nullable=False),
    sa.Column('description', sa.Text(), nullable=True),
    sa.Column('status', sa.String(length=20), nullable=False),
    sa.Column('datetime_start', sa.DateTime(timezone=True), nullable=False),
    sa.Column('datetime_end', sa.DateTime(timezone=True), nullable=False),
    sa.Column('slot_duration_minutes', sa.Integer(), nullable=False),
    sa.Column('user_id', sa.BigInteger(), nullable=True),
    sa.Column('created_at', sa.DateTime(timezone=True), nullable=False),
    sa.Column('closes_at', sa.DateTime(timezone=True), nullable=True),
    sa.Column('finalized_at', sa.DateTime(timezone=True), nullable=True),
    sa.Column('finalized_time', sa.DateTime(timezone=True), nullable=True),
    sa.ForeignKeyConstraint(['user_id'], ['users.id'], ondelete='SET NULL'),
    sa.PrimaryKeyConstraint('id'),
    sa.UniqueConstraint('slug')
    )
    op.create_index('idx_polls_created_at', 'availability_polls', ['created_at'], unique=False)
    op.create_index('idx_polls_status', 'availability_polls', ['status'], unique=False)
    op.create_index('idx_polls_user_id', 'availability_polls', ['user_id'], unique=False)
    op.create_table('claude_config_snapshots',
    sa.Column('id', sa.BigInteger(), autoincrement=True, nullable=False),
    sa.Column('user_id', sa.BigInteger(), nullable=False),
    sa.Column('name', sa.Text(), nullable=False),
    sa.Column('content_hash', sa.Text(), nullable=False),
    sa.Column('claude_account_email', sa.Text(), nullable=True),
    sa.Column('subscription_type', sa.Text(), nullable=True),
    sa.Column('summary', sa.Text(), nullable=True),
    sa.Column('filename', sa.Text(), nullable=False),
    sa.Column('size', sa.Integer(), nullable=False),
    sa.Column('created_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False),
    sa.ForeignKeyConstraint(['user_id'], ['users.id'], ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('id'),
    sa.UniqueConstraint('content_hash'),
    sa.UniqueConstraint('content_hash', name='unique_snapshot_hash')
    )
    op.create_index('idx_snapshots_hash', 'claude_config_snapshots', ['content_hash'], unique=False)
    op.create_index('idx_snapshots_user', 'claude_config_snapshots', ['user_id'], unique=False)
    op.create_index(op.f('ix_claude_config_snapshots_user_id'), 'claude_config_snapshots', ['user_id'], unique=False)
    op.create_table('coding_projects',
    sa.Column('id', sa.BigInteger(), autoincrement=True, nullable=False),
    sa.Column('user_id', sa.BigInteger(), nullable=False),
    sa.Column('directory', sa.Text(), nullable=False),
    sa.Column('name', sa.String(length=255), nullable=True),
    sa.Column('source', sa.String(length=255), nullable=True),
    sa.Column('created_at', sa.DateTime(timezone=True), nullable=False),
    sa.Column('last_accessed_at', sa.DateTime(timezone=True), nullable=False),
    sa.ForeignKeyConstraint(['user_id'], ['users.id'], ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('id'),
    sa.UniqueConstraint('user_id', 'directory', name='unique_user_coding_project')
    )
    op.create_index('idx_coding_projects_directory', 'coding_projects', ['directory'], unique=False)
    op.create_index('idx_coding_projects_source', 'coding_projects', ['source'], unique=False)
    op.create_index('idx_coding_projects_user', 'coding_projects', ['user_id'], unique=False)
    op.create_index(op.f('ix_coding_projects_user_id'), 'coding_projects', ['user_id'], unique=False)
    op.create_table('discord_bot_users',
    sa.Column('user_id', sa.Integer(), nullable=False),
    sa.Column('bot_id', sa.BigInteger(), nullable=False),
    sa.ForeignKeyConstraint(['bot_id'], ['discord_bots.id'], ondelete='CASCADE'),
    sa.ForeignKeyConstraint(['user_id'], ['users.id'], ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('user_id', 'bot_id')
    )
    op.create_table('github_accounts',
    sa.Column('id', sa.BigInteger(), nullable=False),
    sa.Column('user_id', sa.Integer(), nullable=False),
    sa.Column('name', sa.Text(), nullable=False),
    sa.Column('auth_type', sa.Text(), nullable=False),
    sa.Column('access_token', sa.Text(), nullable=True),
    sa.Column('app_id', sa.BigInteger(), nullable=True),
    sa.Column('installation_id', sa.BigInteger(), nullable=True),
    sa.Column('private_key', sa.Text(), nullable=True),
    sa.Column('active', sa.Boolean(), server_default='true', nullable=False),
    sa.Column('last_sync_at', sa.DateTime(timezone=True), nullable=True),
    sa.Column('created_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False),
    sa.Column('updated_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False),
    sa.CheckConstraint("auth_type IN ('pat', 'app')"),
    sa.ForeignKeyConstraint(['user_id'], ['users.id'], ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_index('github_accounts_active_idx', 'github_accounts', ['active', 'last_sync_at'], unique=False)
    op.create_index('github_accounts_user_idx', 'github_accounts', ['user_id'], unique=False)
    op.create_table('google_accounts',
    sa.Column('id', sa.BigInteger(), nullable=False),
    sa.Column('user_id', sa.Integer(), nullable=False),
    sa.Column('name', sa.Text(), nullable=False),
    sa.Column('email', sa.Text(), nullable=False),
    sa.Column('access_token', sa.Text(), nullable=True),
    sa.Column('refresh_token', sa.Text(), nullable=True),
    sa.Column('token_expires_at', sa.DateTime(timezone=True), nullable=True),
    sa.Column('scopes', sa.ARRAY(sa.Text()), server_default='{}', nullable=False),
    sa.Column('active', sa.Boolean(), server_default='true', nullable=False),
    sa.Column('last_sync_at', sa.DateTime(timezone=True), nullable=True),
    sa.Column('sync_error', sa.Text(), nullable=True),
    sa.Column('created_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False),
    sa.Column('updated_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False),
    sa.ForeignKeyConstraint(['user_id'], ['users.id'], ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('id'),
    sa.UniqueConstraint('email')
    )
    op.create_index('google_accounts_active_idx', 'google_accounts', ['active', 'last_sync_at'], unique=False)
    op.create_index('google_accounts_email_idx', 'google_accounts', ['email'], unique=False)
    op.create_index('google_accounts_user_idx', 'google_accounts', ['user_id'], unique=False)
    op.create_table('mcp_server_assignments',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('mcp_server_id', sa.Integer(), nullable=False),
    sa.Column('entity_type', sa.Text(), nullable=False),
    sa.Column('entity_id', sa.BigInteger(), nullable=False),
    sa.Column('created_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=True),
    sa.Column('updated_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=True),
    sa.ForeignKeyConstraint(['mcp_server_id'], ['mcp_servers.id'], ),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_index('mcp_assignment_entity_idx', 'mcp_server_assignments', ['entity_type', 'entity_id'], unique=False)
    op.create_index('mcp_assignment_server_idx', 'mcp_server_assignments', ['mcp_server_id'], unique=False)
    op.create_index('mcp_assignment_unique_idx', 'mcp_server_assignments', ['mcp_server_id', 'entity_type', 'entity_id'], unique=True)
    op.create_table('oauth_client_states',
    sa.Column('id', sa.Integer(), autoincrement=True, nullable=False),
    sa.Column('state', sa.String(), nullable=False),
    sa.Column('provider', sa.String(), nullable=False),
    sa.Column('user_id', sa.Integer(), nullable=False),
    sa.Column('expires_at', sa.DateTime(timezone=True), nullable=False),
    sa.Column('created_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=True),
    sa.ForeignKeyConstraint(['user_id'], ['users.id'], ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_index(op.f('ix_oauth_client_states_provider'), 'oauth_client_states', ['provider'], unique=False)
    op.create_index(op.f('ix_oauth_client_states_state'), 'oauth_client_states', ['state'], unique=True)
    op.create_table('oauth_states',
    sa.Column('state', sa.String(), nullable=False),
    sa.Column('code', sa.String(), nullable=True),
    sa.Column('redirect_uri', sa.String(), nullable=False),
    sa.Column('redirect_uri_provided_explicitly', sa.Boolean(), nullable=False),
    sa.Column('code_challenge', sa.String(), nullable=True),
    sa.Column('stale', sa.Boolean(), nullable=False),
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('client_id', sa.String(), nullable=False),
    sa.Column('user_id', sa.Integer(), nullable=True),
    sa.Column('scopes', sa.ARRAY(sa.String()), nullable=False),
    sa.Column('created_at', sa.DateTime(), server_default=sa.text('now()'), nullable=True),
    sa.Column('expires_at', sa.DateTime(), nullable=False),
    sa.ForeignKeyConstraint(['client_id'], ['oauth_client.client_id'], ),
    sa.ForeignKeyConstraint(['user_id'], ['users.id'], ),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_table('pending_jobs',
    sa.Column('id', sa.BigInteger(), autoincrement=True, nullable=False),
    sa.Column('job_type', sa.String(length=50), nullable=False),
    sa.Column('external_id', sa.String(length=200), nullable=True),
    sa.Column('celery_task_id', sa.String(length=200), nullable=True),
    sa.Column('status', sa.String(length=20), nullable=False),
    sa.Column('error_message', sa.Text(), nullable=True),
    sa.Column('result_id', sa.BigInteger(), nullable=True),
    sa.Column('result_type', sa.String(length=50), nullable=True),
    sa.Column('params', postgresql.JSONB(astext_type=sa.Text()), nullable=False),
    sa.Column('created_at', sa.DateTime(timezone=True), nullable=False),
    sa.Column('updated_at', sa.DateTime(timezone=True), nullable=False),
    sa.Column('completed_at', sa.DateTime(timezone=True), nullable=True),
    sa.Column('attempts', sa.Integer(), nullable=False),
    sa.Column('user_id', sa.BigInteger(), nullable=True),
    sa.ForeignKeyConstraint(['user_id'], ['users.id'], ondelete='SET NULL'),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_index('idx_pending_jobs_celery_task_id', 'pending_jobs', ['celery_task_id'], unique=False)
    op.create_index('idx_pending_jobs_created_at', 'pending_jobs', ['created_at'], unique=False)
    op.create_index('idx_pending_jobs_external_id', 'pending_jobs', ['external_id'], unique=False)
    op.create_index('idx_pending_jobs_job_type', 'pending_jobs', ['job_type'], unique=False)
    op.create_index('idx_pending_jobs_status', 'pending_jobs', ['status'], unique=False)
    op.create_index('idx_pending_jobs_user_id', 'pending_jobs', ['user_id'], unique=False)
    op.create_table('secrets',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('user_id', sa.Integer(), nullable=False),
    sa.Column('name', sa.String(), nullable=False),
    sa.Column('encrypted_value', sa.LargeBinary(), nullable=False),
    sa.Column('description', sa.String(), nullable=True),
    sa.Column('created_at', sa.DateTime(), nullable=False),
    sa.Column('updated_at', sa.DateTime(), nullable=False),
    sa.ForeignKeyConstraint(['user_id'], ['users.id'], ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('id'),
    sa.UniqueConstraint('user_id', 'name', name='unique_secret_per_user')
    )
    op.create_index(op.f('ix_secrets_name'), 'secrets', ['name'], unique=False)
    op.create_table('telemetry_events',
    sa.Column('id', sa.BigInteger(), autoincrement=True, nullable=False),
    sa.Column('timestamp', sa.DateTime(timezone=True), nullable=False),
    sa.Column('user_id', sa.BigInteger(), nullable=False),
    sa.Column('event_type', sa.String(length=50), nullable=False),
    sa.Column('name', sa.String(length=100), nullable=False),
    sa.Column('value', sa.Float(), nullable=True),
    sa.Column('session_id', sa.String(length=100), nullable=True),
    sa.Column('source', sa.String(length=100), nullable=True),
    sa.Column('tool_name', sa.String(length=100), nullable=True),
    sa.Column('attributes', postgresql.JSONB(astext_type=sa.Text()), nullable=False),
    sa.Column('body', sa.Text(), nullable=True),
    sa.ForeignKeyConstraint(['user_id'], ['users.id'], ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_index('idx_telemetry_events_attrs', 'telemetry_events', ['attributes'], unique=False, postgresql_using='gin')
    op.create_index('idx_telemetry_events_name_ts', 'telemetry_events', ['name', 'timestamp'], unique=False)
    op.create_index('idx_telemetry_events_session', 'telemetry_events', ['session_id', 'timestamp'], unique=False)
    op.create_index('idx_telemetry_events_source', 'telemetry_events', ['source', 'timestamp'], unique=False)
    op.create_index('idx_telemetry_events_timestamp', 'telemetry_events', ['timestamp'], unique=False)
    op.create_index('idx_telemetry_events_type_name', 'telemetry_events', ['event_type', 'name'], unique=False)
    op.create_index('idx_telemetry_events_user_ts', 'telemetry_events', ['user_id', 'timestamp'], unique=False)
    op.create_index(op.f('ix_telemetry_events_session_id'), 'telemetry_events', ['session_id'], unique=False)
    op.create_index(op.f('ix_telemetry_events_user_id'), 'telemetry_events', ['user_id'], unique=False)
    op.create_table('watched_markets',
    sa.Column('id', sa.Integer(), autoincrement=True, nullable=False),
    sa.Column('market_id', sa.String(length=255), nullable=False),
    sa.Column('source', sa.String(length=50), nullable=False),
    sa.Column('question', sa.Text(), nullable=True),
    sa.Column('url', sa.String(length=500), nullable=True),
    sa.Column('added_at', sa.DateTime(timezone=True), nullable=False),
    sa.Column('last_updated', sa.DateTime(timezone=True), nullable=True),
    sa.Column('price_when_added', sa.Float(), nullable=True),
    sa.Column('last_price', sa.Float(), nullable=True),
    sa.Column('alert_threshold', sa.Float(), nullable=True),
    sa.Column('user_id', sa.Integer(), nullable=False),
    sa.ForeignKeyConstraint(['user_id'], ['users.id'], ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('id'),
    sa.UniqueConstraint('user_id', 'market_id', 'source', name='uq_watched_market')
    )
    op.create_index('ix_watched_markets_user_id', 'watched_markets', ['user_id'], unique=False)
    op.create_table('claude_environments',
    sa.Column('id', sa.BigInteger(), autoincrement=True, nullable=False),
    sa.Column('user_id', sa.BigInteger(), nullable=False),
    sa.Column('name', sa.Text(), nullable=False),
    sa.Column('description', sa.Text(), nullable=True),
    sa.Column('volume_name', sa.Text(), nullable=False),
    sa.Column('initialized_from_snapshot_id', sa.BigInteger(), nullable=True),
    sa.Column('size_bytes', sa.BigInteger(), nullable=True),
    sa.Column('last_used_at', sa.DateTime(timezone=True), nullable=True),
    sa.Column('session_count', sa.Integer(), nullable=False),
    sa.Column('created_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False),
    sa.ForeignKeyConstraint(['initialized_from_snapshot_id'], ['claude_config_snapshots.id'], ondelete='SET NULL'),
    sa.ForeignKeyConstraint(['user_id'], ['users.id'], ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('id'),
    sa.UniqueConstraint('volume_name'),
    sa.UniqueConstraint('volume_name', name='unique_environment_volume')
    )
    op.create_index('idx_environments_user', 'claude_environments', ['user_id'], unique=False)
    op.create_index(op.f('ix_claude_environments_user_id'), 'claude_environments', ['user_id'], unique=False)
    op.create_table('github_projects',
    sa.Column('id', sa.BigInteger(), nullable=False),
    sa.Column('account_id', sa.BigInteger(), nullable=False),
    sa.Column('node_id', sa.Text(), nullable=False),
    sa.Column('number', sa.Integer(), nullable=False),
    sa.Column('owner_type', sa.Text(), nullable=False),
    sa.Column('owner_login', sa.Text(), nullable=False),
    sa.Column('title', sa.Text(), nullable=False),
    sa.Column('short_description', sa.Text(), nullable=True),
    sa.Column('readme', sa.Text(), nullable=True),
    sa.Column('url', sa.Text(), nullable=False),
    sa.Column('public', sa.Boolean(), server_default='false', nullable=False),
    sa.Column('closed', sa.Boolean(), server_default='false', nullable=False),
    sa.Column('fields', postgresql.JSONB(astext_type=sa.Text()), server_default='[]', nullable=False),
    sa.Column('items_total_count', sa.Integer(), server_default='0', nullable=False),
    sa.Column('github_created_at', sa.DateTime(timezone=True), nullable=True),
    sa.Column('github_updated_at', sa.DateTime(timezone=True), nullable=True),
    sa.Column('last_sync_at', sa.DateTime(timezone=True), nullable=True),
    sa.Column('created_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False),
    sa.Column('updated_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False),
    sa.ForeignKeyConstraint(['account_id'], ['github_accounts.id'], ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('id'),
    sa.UniqueConstraint('account_id', 'owner_login', 'number', name='unique_project_per_account')
    )
    op.create_index('github_projects_owner_idx', 'github_projects', ['owner_login', 'number'], unique=False)
    op.create_index('github_projects_title_idx', 'github_projects', ['title'], unique=False)
    op.create_table('github_repos',
    sa.Column('id', sa.BigInteger(), nullable=False),
    sa.Column('account_id', sa.BigInteger(), nullable=False),
    sa.Column('github_id', sa.BigInteger(), nullable=True),
    sa.Column('owner', sa.Text(), nullable=False),
    sa.Column('name', sa.Text(), nullable=False),
    sa.Column('track_issues', sa.Boolean(), server_default='true', nullable=False),
    sa.Column('track_prs', sa.Boolean(), server_default='true', nullable=False),
    sa.Column('track_comments', sa.Boolean(), server_default='true', nullable=False),
    sa.Column('track_project_fields', sa.Boolean(), server_default='false', nullable=False),
    sa.Column('labels_filter', sa.ARRAY(sa.Text()), server_default='{}', nullable=False),
    sa.Column('state_filter', sa.Text(), nullable=True),
    sa.Column('tags', sa.ARRAY(sa.Text()), server_default='{}', nullable=False),
    sa.Column('check_interval', sa.Integer(), server_default='60', nullable=False),
    sa.Column('last_sync_at', sa.DateTime(timezone=True), nullable=True),
    sa.Column('full_sync_interval', sa.Integer(), server_default='1440', nullable=False),
    sa.Column('last_full_sync_at', sa.DateTime(timezone=True), nullable=True),
    sa.Column('active', sa.Boolean(), server_default='true', nullable=False),
    sa.Column('created_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False),
    sa.Column('updated_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False),
    sa.ForeignKeyConstraint(['account_id'], ['github_accounts.id'], ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_index('github_repos_active_idx', 'github_repos', ['active', 'last_sync_at'], unique=False)
    op.create_index('github_repos_owner_name_idx', 'github_repos', ['owner', 'name'], unique=False)
    op.create_table('github_teams',
    sa.Column('id', sa.BigInteger(), nullable=False),
    sa.Column('account_id', sa.BigInteger(), nullable=False),
    sa.Column('node_id', sa.Text(), nullable=False),
    sa.Column('slug', sa.Text(), nullable=False),
    sa.Column('github_id', sa.BigInteger(), nullable=False),
    sa.Column('name', sa.Text(), nullable=False),
    sa.Column('description', sa.Text(), nullable=True),
    sa.Column('privacy', sa.Text(), nullable=False),
    sa.Column('permission', sa.Text(), nullable=True),
    sa.Column('org_login', sa.Text(), nullable=False),
    sa.Column('parent_team_id', sa.BigInteger(), nullable=True),
    sa.Column('members_count', sa.Integer(), server_default='0', nullable=False),
    sa.Column('github_created_at', sa.DateTime(timezone=True), nullable=True),
    sa.Column('github_updated_at', sa.DateTime(timezone=True), nullable=True),
    sa.Column('last_sync_at', sa.DateTime(timezone=True), nullable=True),
    sa.Column('created_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False),
    sa.Column('updated_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False),
    sa.ForeignKeyConstraint(['account_id'], ['github_accounts.id'], ondelete='CASCADE'),
    sa.ForeignKeyConstraint(['parent_team_id'], ['github_teams.id'], ),
    sa.PrimaryKeyConstraint('id'),
    sa.UniqueConstraint('account_id', 'org_login', 'slug', name='unique_team_per_account')
    )
    op.create_index('github_teams_org_idx', 'github_teams', ['org_login'], unique=False)
    op.create_index('github_teams_slug_idx', 'github_teams', ['slug'], unique=False)
    op.create_table('sessions',
    sa.Column('id', sa.UUID(), nullable=False),
    sa.Column('user_id', sa.BigInteger(), nullable=False),
    sa.Column('coding_project_id', sa.BigInteger(), nullable=True),
    sa.Column('parent_session_id', sa.UUID(), nullable=True),
    sa.Column('git_branch', sa.String(length=255), nullable=True),
    sa.Column('tool_version', sa.String(length=50), nullable=True),
    sa.Column('source', sa.String(length=255), nullable=True),
    sa.Column('transcript_path', sa.Text(), nullable=True),
    sa.Column('started_at', sa.DateTime(timezone=True), nullable=False),
    sa.Column('ended_at', sa.DateTime(timezone=True), nullable=True),
    sa.ForeignKeyConstraint(['coding_project_id'], ['coding_projects.id'], ondelete='SET NULL'),
    sa.ForeignKeyConstraint(['parent_session_id'], ['sessions.id'], ondelete='SET NULL'),
    sa.ForeignKeyConstraint(['user_id'], ['users.id'], ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_index('idx_sessions_coding_project', 'sessions', ['coding_project_id'], unique=False)
    op.create_index('idx_sessions_ended', 'sessions', ['ended_at'], unique=False)
    op.create_index('idx_sessions_parent', 'sessions', ['parent_session_id'], unique=False)
    op.create_index('idx_sessions_source', 'sessions', ['source'], unique=False)
    op.create_index('idx_sessions_started', 'sessions', ['started_at'], unique=False)
    op.create_index('idx_sessions_user', 'sessions', ['user_id'], unique=False)
    op.create_index(op.f('ix_sessions_coding_project_id'), 'sessions', ['coding_project_id'], unique=False)
    op.create_index(op.f('ix_sessions_parent_session_id'), 'sessions', ['parent_session_id'], unique=False)
    op.create_index(op.f('ix_sessions_user_id'), 'sessions', ['user_id'], unique=False)
    op.create_table('user_sessions',
    sa.Column('id', sa.String(), nullable=False),
    sa.Column('oauth_state_id', sa.Integer(), nullable=True),
    sa.Column('user_id', sa.Integer(), nullable=False),
    sa.Column('created_at', sa.DateTime(), server_default=sa.text('now()'), nullable=True),
    sa.Column('expires_at', sa.DateTime(), nullable=False),
    sa.ForeignKeyConstraint(['oauth_state_id'], ['oauth_states.id'], ),
    sa.ForeignKeyConstraint(['user_id'], ['users.id'], ),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_table('oauth_refresh_tokens',
    sa.Column('token', sa.String(), nullable=False),
    sa.Column('revoked', sa.Boolean(), nullable=False),
    sa.Column('access_token_session_id', sa.String(), nullable=True),
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('client_id', sa.String(), nullable=False),
    sa.Column('user_id', sa.Integer(), nullable=True),
    sa.Column('scopes', sa.ARRAY(sa.String()), nullable=False),
    sa.Column('created_at', sa.DateTime(), server_default=sa.text('now()'), nullable=True),
    sa.Column('expires_at', sa.DateTime(), nullable=False),
    sa.ForeignKeyConstraint(['access_token_session_id'], ['user_sessions.id'], ),
    sa.ForeignKeyConstraint(['client_id'], ['oauth_client.client_id'], ),
    sa.ForeignKeyConstraint(['user_id'], ['users.id'], ),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_table('projects',
    sa.Column('id', sa.BigInteger(), nullable=False),
    sa.Column('repo_id', sa.BigInteger(), nullable=True),
    sa.Column('github_id', sa.BigInteger(), nullable=True),
    sa.Column('number', sa.Integer(), nullable=True),
    sa.Column('title', sa.Text(), nullable=False),
    sa.Column('description', sa.Text(), nullable=True),
    sa.Column('state', sa.Text(), nullable=False),
    sa.Column('due_on', sa.DateTime(timezone=True), nullable=True),
    sa.Column('parent_id', sa.BigInteger(), nullable=True),
    sa.Column('github_created_at', sa.DateTime(timezone=True), nullable=True),
    sa.Column('github_updated_at', sa.DateTime(timezone=True), nullable=True),
    sa.Column('closed_at', sa.DateTime(timezone=True), nullable=True),
    sa.Column('created_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False),
    sa.Column('updated_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False),
    sa.CheckConstraint('id != parent_id', name='ck_milestone_not_self_parent'),
    sa.ForeignKeyConstraint(['parent_id'], ['projects.id'], ondelete='SET NULL'),
    sa.ForeignKeyConstraint(['repo_id'], ['github_repos.id'], ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_index('projects_due_idx', 'projects', ['due_on'], unique=False)
    op.create_index('projects_parent_idx', 'projects', ['parent_id'], unique=False)
    op.create_index('projects_repo_idx', 'projects', ['repo_id'], unique=False)
    op.create_index('unique_github_milestone_per_repo', 'projects', ['repo_id', 'number'], unique=True, postgresql_where=sa.text('repo_id IS NOT NULL'))
    op.create_table('article_feeds',
    sa.Column('id', sa.BigInteger(), nullable=False),
    sa.Column('url', sa.Text(), nullable=False),
    sa.Column('title', sa.Text(), nullable=True),
    sa.Column('description', sa.Text(), nullable=True),
    sa.Column('tags', sa.ARRAY(sa.Text()), server_default='{}', nullable=False),
    sa.Column('check_interval', sa.Integer(), server_default='60', nullable=False),
    sa.Column('last_checked_at', sa.DateTime(timezone=True), nullable=True),
    sa.Column('active', sa.Boolean(), server_default='true', nullable=False),
    sa.Column('created_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False),
    sa.Column('updated_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False),
    sa.Column('project_id', sa.BigInteger(), nullable=True),
    sa.Column('sensitivity', sa.String(length=20), server_default='public', nullable=False),
    sa.Column('config_version', sa.Integer(), server_default='1', nullable=False),
    sa.CheckConstraint("sensitivity IN ('public', 'basic', 'internal', 'confidential')", name='valid_article_feed_sensitivity'),
    sa.ForeignKeyConstraint(['project_id'], ['projects.id'], ondelete='SET NULL'),
    sa.PrimaryKeyConstraint('id'),
    sa.UniqueConstraint('url')
    )
    op.create_index('article_feeds_active_idx', 'article_feeds', ['active', 'last_checked_at'], unique=False)
    op.create_index('article_feeds_project_idx', 'article_feeds', ['project_id'], unique=False)
    op.create_index('article_feeds_tags_idx', 'article_feeds', ['tags'], unique=False, postgresql_using='gin')
    op.create_table('calendar_accounts',
    sa.Column('id', sa.BigInteger(), nullable=False),
    sa.Column('name', sa.Text(), nullable=False),
    sa.Column('calendar_type', sa.Text(), nullable=False),
    sa.Column('caldav_url', sa.Text(), nullable=True),
    sa.Column('caldav_username', sa.Text(), nullable=True),
    sa.Column('caldav_password', sa.Text(), nullable=True),
    sa.Column('google_account_id', sa.BigInteger(), nullable=True),
    sa.Column('calendar_ids', sa.ARRAY(sa.Text()), server_default='{}', nullable=False),
    sa.Column('tags', sa.ARRAY(sa.Text()), server_default='{}', nullable=False),
    sa.Column('check_interval', sa.Integer(), server_default='15', nullable=False),
    sa.Column('sync_past_days', sa.Integer(), server_default='30', nullable=False),
    sa.Column('sync_future_days', sa.Integer(), server_default='90', nullable=False),
    sa.Column('last_sync_at', sa.DateTime(timezone=True), nullable=True),
    sa.Column('sync_error', sa.Text(), nullable=True),
    sa.Column('active', sa.Boolean(), server_default='true', nullable=False),
    sa.Column('created_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False),
    sa.Column('updated_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False),
    sa.Column('project_id', sa.BigInteger(), nullable=True),
    sa.Column('sensitivity', sa.String(length=20), server_default='basic', nullable=False),
    sa.Column('config_version', sa.Integer(), server_default='1', nullable=False),
    sa.CheckConstraint("calendar_type IN ('caldav', 'google')"),
    sa.CheckConstraint("sensitivity IN ('public', 'basic', 'internal', 'confidential')", name='valid_calendar_account_sensitivity'),
    sa.ForeignKeyConstraint(['google_account_id'], ['google_accounts.id'], ondelete='SET NULL'),
    sa.ForeignKeyConstraint(['project_id'], ['projects.id'], ondelete='SET NULL'),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_index('calendar_accounts_active_idx', 'calendar_accounts', ['active', 'last_sync_at'], unique=False)
    op.create_index('calendar_accounts_project_idx', 'calendar_accounts', ['project_id'], unique=False)
    op.create_index('calendar_accounts_type_idx', 'calendar_accounts', ['calendar_type'], unique=False)
    op.create_table('discord_servers',
    sa.Column('id', sa.BigInteger(), nullable=False),
    sa.Column('name', sa.Text(), nullable=False),
    sa.Column('description', sa.Text(), nullable=True),
    sa.Column('member_count', sa.Integer(), nullable=True),
    sa.Column('collect_messages', sa.Boolean(), nullable=False),
    sa.Column('last_sync_at', sa.DateTime(timezone=True), nullable=True),
    sa.Column('created_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=True),
    sa.Column('updated_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=True),
    sa.Column('project_id', sa.BigInteger(), nullable=True),
    sa.Column('sensitivity', sa.String(length=20), server_default='basic', nullable=False),
    sa.Column('config_version', sa.Integer(), server_default='1', nullable=False),
    sa.CheckConstraint("sensitivity IN ('public', 'basic', 'internal', 'confidential')", name='valid_discord_server_sensitivity'),
    sa.ForeignKeyConstraint(['project_id'], ['projects.id'], ondelete='SET NULL'),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_index('discord_servers_collect_idx', 'discord_servers', ['collect_messages'], unique=False)
    op.create_index('discord_servers_project_idx', 'discord_servers', ['project_id'], unique=False)
    op.create_table('email_accounts',
    sa.Column('id', sa.BigInteger(), nullable=False),
    sa.Column('user_id', sa.Integer(), nullable=False),
    sa.Column('name', sa.Text(), nullable=False),
    sa.Column('email_address', sa.Text(), nullable=False),
    sa.Column('account_type', sa.Text(), server_default='imap', nullable=False),
    sa.Column('imap_server', sa.Text(), nullable=True),
    sa.Column('imap_port', sa.Integer(), nullable=True),
    sa.Column('username', sa.Text(), nullable=True),
    sa.Column('password', sa.Text(), nullable=True),
    sa.Column('use_ssl', sa.Boolean(), nullable=True),
    sa.Column('smtp_server', sa.Text(), nullable=True),
    sa.Column('smtp_port', sa.Integer(), nullable=True),
    sa.Column('google_account_id', sa.BigInteger(), nullable=True),
    sa.Column('folders', sa.ARRAY(sa.Text()), server_default='{}', nullable=False),
    sa.Column('tags', sa.ARRAY(sa.Text()), server_default='{}', nullable=False),
    sa.Column('last_sync_at', sa.DateTime(timezone=True), nullable=True),
    sa.Column('sync_error', sa.Text(), nullable=True),
    sa.Column('active', sa.Boolean(), server_default='true', nullable=False),
    sa.Column('send_enabled', sa.Boolean(), server_default='true', nullable=False),
    sa.Column('created_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False),
    sa.Column('updated_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False),
    sa.Column('project_id', sa.BigInteger(), nullable=True),
    sa.Column('sensitivity', sa.String(length=20), server_default='basic', nullable=False),
    sa.Column('config_version', sa.Integer(), server_default='1', nullable=False),
    sa.CheckConstraint("account_type IN ('imap', 'gmail')"),
    sa.CheckConstraint("sensitivity IN ('public', 'basic', 'internal', 'confidential')", name='valid_email_account_sensitivity'),
    sa.ForeignKeyConstraint(['google_account_id'], ['google_accounts.id'], ),
    sa.ForeignKeyConstraint(['project_id'], ['projects.id'], ondelete='SET NULL'),
    sa.ForeignKeyConstraint(['user_id'], ['users.id'], ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('id'),
    sa.UniqueConstraint('email_address')
    )
    op.create_index('email_accounts_active_idx', 'email_accounts', ['active', 'last_sync_at'], unique=False)
    op.create_index('email_accounts_address_idx', 'email_accounts', ['email_address'], unique=True)
    op.create_index('email_accounts_project_idx', 'email_accounts', ['project_id'], unique=False)
    op.create_index('email_accounts_tags_idx', 'email_accounts', ['tags'], unique=False, postgresql_using='gin')
    op.create_index('email_accounts_type_idx', 'email_accounts', ['account_type'], unique=False)
    op.create_index('email_accounts_user_idx', 'email_accounts', ['user_id'], unique=False)
    op.create_table('google_folders',
    sa.Column('id', sa.BigInteger(), nullable=False),
    sa.Column('account_id', sa.BigInteger(), nullable=False),
    sa.Column('folder_id', sa.Text(), nullable=False),
    sa.Column('folder_name', sa.Text(), nullable=False),
    sa.Column('folder_path', sa.Text(), nullable=True),
    sa.Column('recursive', sa.Boolean(), server_default='true', nullable=False),
    sa.Column('include_shared', sa.Boolean(), server_default='false', nullable=False),
    sa.Column('mime_type_filter', sa.ARRAY(sa.Text()), server_default='{}', nullable=False),
    sa.Column('exclude_folder_ids', sa.ARRAY(sa.Text()), server_default='{}', nullable=False),
    sa.Column('tags', sa.ARRAY(sa.Text()), server_default='{}', nullable=False),
    sa.Column('check_interval', sa.Integer(), server_default='60', nullable=False),
    sa.Column('last_sync_at', sa.DateTime(timezone=True), nullable=True),
    sa.Column('active', sa.Boolean(), server_default='true', nullable=False),
    sa.Column('created_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False),
    sa.Column('updated_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False),
    sa.Column('project_id', sa.BigInteger(), nullable=True),
    sa.Column('sensitivity', sa.String(length=20), server_default='basic', nullable=False),
    sa.Column('config_version', sa.Integer(), server_default='1', nullable=False),
    sa.CheckConstraint("sensitivity IN ('public', 'basic', 'internal', 'confidential')", name='valid_google_folder_sensitivity'),
    sa.ForeignKeyConstraint(['account_id'], ['google_accounts.id'], ondelete='CASCADE'),
    sa.ForeignKeyConstraint(['project_id'], ['projects.id'], ondelete='SET NULL'),
    sa.PrimaryKeyConstraint('id'),
    sa.UniqueConstraint('account_id', 'folder_id', name='unique_folder_per_account')
    )
    op.create_index('google_folders_active_idx', 'google_folders', ['active', 'last_sync_at'], unique=False)
    op.create_index('google_folders_project_idx', 'google_folders', ['project_id'], unique=False)
    op.create_table('slack_workspaces',
    sa.Column('id', sa.Text(), nullable=False),
    sa.Column('name', sa.Text(), nullable=False),
    sa.Column('domain', sa.Text(), nullable=True),
    sa.Column('collect_messages', sa.Boolean(), nullable=False),
    sa.Column('sync_interval_seconds', sa.Integer(), nullable=False),
    sa.Column('last_sync_at', sa.DateTime(timezone=True), nullable=True),
    sa.Column('sync_error', sa.Text(), nullable=True),
    sa.Column('created_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=True),
    sa.Column('updated_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=True),
    sa.Column('project_id', sa.BigInteger(), nullable=True),
    sa.Column('sensitivity', sa.String(length=20), server_default='basic', nullable=False),
    sa.Column('config_version', sa.Integer(), server_default='1', nullable=False),
    sa.CheckConstraint("sensitivity IN ('public', 'basic', 'internal', 'confidential')", name='valid_slack_workspace_sensitivity'),
    sa.ForeignKeyConstraint(['project_id'], ['projects.id'], ondelete='SET NULL'),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_index('slack_workspaces_collect_idx', 'slack_workspaces', ['collect_messages'], unique=False)
    op.create_index('slack_workspaces_project_idx', 'slack_workspaces', ['project_id'], unique=False)
    op.create_table('source_item',
    sa.Column('id', sa.BigInteger(), nullable=False),
    sa.Column('modality', sa.Text(), nullable=False),
    sa.Column('sha256', postgresql.BYTEA(), nullable=False),
    sa.Column('inserted_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=True),
    sa.Column('tags', sa.ARRAY(sa.Text()), server_default='{}', nullable=False),
    sa.Column('size', sa.Integer(), nullable=True),
    sa.Column('mime_type', sa.Text(), nullable=True),
    sa.Column('content', sa.Text(), nullable=True),
    sa.Column('filename', sa.Text(), nullable=True),
    sa.Column('embed_status', sa.Text(), server_default='RAW', nullable=False),
    sa.Column('type', sa.String(length=50), nullable=True),
    sa.Column('last_verified_at', sa.DateTime(timezone=True), nullable=True),
    sa.Column('verification_failures', sa.Integer(), server_default='0', nullable=False),
    sa.Column('project_id', sa.BigInteger(), nullable=True),
    sa.Column('sensitivity', sa.String(length=20), server_default='basic', nullable=False),
    sa.CheckConstraint("embed_status IN ('RAW','QUEUED','STORED','FAILED','SKIPPED')"),
    sa.CheckConstraint("sensitivity IN ('public', 'basic', 'internal', 'confidential')", name='valid_sensitivity_level'),
    sa.CheckConstraint('verification_failures >= 0', name='verification_failures_non_negative'),
    sa.ForeignKeyConstraint(['project_id'], ['projects.id'], ondelete='SET NULL'),
    sa.PrimaryKeyConstraint('id'),
    sa.UniqueConstraint('sha256')
    )
    op.create_index('source_filename_idx', 'source_item', ['filename'], unique=False)
    op.create_index('source_modality_idx', 'source_item', ['modality'], unique=False)
    op.create_index('source_project_idx', 'source_item', ['project_id'], unique=False)
    op.create_index('source_sensitivity_idx', 'source_item', ['sensitivity'], unique=False)
    op.create_index('source_status_idx', 'source_item', ['embed_status'], unique=False)
    op.create_index('source_tags_idx', 'source_item', ['tags'], unique=False, postgresql_using='gin')
    op.create_index('source_verified_at_idx', 'source_item', ['type', 'last_verified_at'], unique=False)
    op.create_table('agent_observation',
    sa.Column('id', sa.BigInteger(), nullable=False),
    sa.Column('session_id', sa.Text(), nullable=True),
    sa.Column('observation_type', sa.Text(), nullable=False),
    sa.Column('subject', sa.Text(), nullable=False),
    sa.Column('evidence', postgresql.JSONB(astext_type=sa.Text()), nullable=True),
    sa.Column('agent_model', sa.Text(), nullable=False),
    sa.ForeignKeyConstraint(['id'], ['source_item.id'], ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_index('agent_obs_model_idx', 'agent_observation', ['agent_model'], unique=False)
    op.create_index('agent_obs_session_idx', 'agent_observation', ['session_id'], unique=False)
    op.create_index('agent_obs_subject_idx', 'agent_observation', ['subject'], unique=False)
    op.create_index('agent_obs_type_idx', 'agent_observation', ['observation_type'], unique=False)
    op.create_table('blog_post',
    sa.Column('id', sa.BigInteger(), nullable=False),
    sa.Column('url', sa.Text(), nullable=True),
    sa.Column('title', sa.Text(), nullable=True),
    sa.Column('author', sa.Text(), nullable=True),
    sa.Column('published', sa.DateTime(timezone=True), nullable=True),
    sa.Column('description', sa.Text(), nullable=True),
    sa.Column('domain', sa.Text(), nullable=True),
    sa.Column('word_count', sa.Integer(), nullable=True),
    sa.Column('images', sa.ARRAY(sa.Text()), nullable=True),
    sa.Column('webpage_metadata', postgresql.JSONB(astext_type=sa.Text()), nullable=True),
    sa.Column('feed_id', sa.BigInteger(), nullable=True),
    sa.ForeignKeyConstraint(['feed_id'], ['article_feeds.id'], ondelete='SET NULL'),
    sa.ForeignKeyConstraint(['id'], ['source_item.id'], ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('id'),
    sa.UniqueConstraint('url')
    )
    op.create_index('blog_post_author_idx', 'blog_post', ['author'], unique=False)
    op.create_index('blog_post_domain_idx', 'blog_post', ['domain'], unique=False)
    op.create_index('blog_post_feed_idx', 'blog_post', ['feed_id'], unique=False)
    op.create_index('blog_post_published_idx', 'blog_post', ['published'], unique=False)
    op.create_index('blog_post_word_count_idx', 'blog_post', ['word_count'], unique=False)
    op.create_table('book_section',
    sa.Column('id', sa.BigInteger(), nullable=False),
    sa.Column('book_id', sa.BigInteger(), nullable=False),
    sa.Column('section_title', sa.Text(), nullable=True),
    sa.Column('section_number', sa.Integer(), nullable=True),
    sa.Column('section_level', sa.Integer(), nullable=True),
    sa.Column('start_page', sa.Integer(), nullable=True),
    sa.Column('end_page', sa.Integer(), nullable=True),
    sa.Column('parent_section_id', sa.BigInteger(), nullable=True),
    sa.ForeignKeyConstraint(['book_id'], ['book.id'], ondelete='CASCADE'),
    sa.ForeignKeyConstraint(['id'], ['source_item.id'], ondelete='CASCADE'),
    sa.ForeignKeyConstraint(['parent_section_id'], ['book_section.id'], ),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_index('book_section_book_idx', 'book_section', ['book_id'], unique=False)
    op.create_index('book_section_level_idx', 'book_section', ['section_level', 'section_number'], unique=False)
    op.create_index('book_section_parent_idx', 'book_section', ['parent_section_id'], unique=False)
    op.create_table('calendar_event',
    sa.Column('id', sa.BigInteger(), nullable=False),
    sa.Column('event_title', sa.Text(), nullable=False),
    sa.Column('start_time', sa.DateTime(timezone=True), nullable=False),
    sa.Column('end_time', sa.DateTime(timezone=True), nullable=True),
    sa.Column('all_day', sa.Boolean(), nullable=False),
    sa.Column('location', sa.Text(), nullable=True),
    sa.Column('recurrence_rule', sa.Text(), nullable=True),
    sa.Column('calendar_account_id', sa.BigInteger(), nullable=True),
    sa.Column('calendar_name', sa.Text(), nullable=True),
    sa.Column('external_id', sa.Text(), nullable=True),
    sa.Column('event_metadata', postgresql.JSONB(astext_type=sa.Text()), nullable=False),
    sa.ForeignKeyConstraint(['calendar_account_id'], ['calendar_accounts.id'], ondelete='SET NULL'),
    sa.ForeignKeyConstraint(['id'], ['source_item.id'], ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_index('calendar_event_account_idx', 'calendar_event', ['calendar_account_id'], unique=False)
    op.create_index('calendar_event_calendar_idx', 'calendar_event', ['calendar_name'], unique=False)
    op.create_index('calendar_event_end_idx', 'calendar_event', ['end_time'], unique=False)
    op.create_index('calendar_event_external_idx', 'calendar_event', ['calendar_account_id', 'external_id'], unique=True, postgresql_where='external_id IS NOT NULL')
    op.create_index('calendar_event_start_idx', 'calendar_event', ['start_time'], unique=False)
    op.create_table('chat_message',
    sa.Column('id', sa.BigInteger(), nullable=False),
    sa.Column('platform', sa.Text(), nullable=True),
    sa.Column('channel_id', sa.Text(), nullable=True),
    sa.Column('author', sa.Text(), nullable=True),
    sa.Column('sent_at', sa.DateTime(timezone=True), nullable=True),
    sa.ForeignKeyConstraint(['id'], ['source_item.id'], ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_index('chat_channel_idx', 'chat_message', ['platform', 'channel_id'], unique=False)
    op.create_table('chunk',
    sa.Column('id', sa.UUID(), server_default=sa.text('uuid_generate_v4()'), nullable=False),
    sa.Column('source_id', sa.BigInteger(), nullable=False),
    sa.Column('file_paths', sa.ARRAY(sa.Text()), nullable=True),
    sa.Column('content', sa.Text(), nullable=True),
    sa.Column('embedding_model', sa.Text(), nullable=True),
    sa.Column('collection_name', sa.Text(), nullable=True),
    sa.Column('created_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=True),
    sa.Column('checked_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=True),
    sa.Column('search_vector', postgresql.TSVECTOR(), nullable=True),
    sa.CheckConstraint('(file_paths IS NOT NULL) OR (content IS NOT NULL)'),
    sa.ForeignKeyConstraint(['source_id'], ['source_item.id'], ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_index('chunk_collection_idx', 'chunk', ['collection_name'], unique=False)
    op.create_index('chunk_source_idx', 'chunk', ['source_id'], unique=False)
    op.create_table('comic',
    sa.Column('id', sa.BigInteger(), nullable=False),
    sa.Column('title', sa.Text(), nullable=True),
    sa.Column('author', sa.Text(), nullable=True),
    sa.Column('published', sa.DateTime(timezone=True), nullable=True),
    sa.Column('volume', sa.Text(), nullable=True),
    sa.Column('issue', sa.Text(), nullable=True),
    sa.Column('page', sa.Integer(), nullable=True),
    sa.Column('url', sa.Text(), nullable=True),
    sa.ForeignKeyConstraint(['id'], ['source_item.id'], ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_index('comic_author_idx', 'comic', ['author'], unique=False)
    op.create_table('confidence_score',
    sa.Column('id', sa.BigInteger(), nullable=False),
    sa.Column('source_item_id', sa.BigInteger(), nullable=False),
    sa.Column('confidence_type', sa.Text(), nullable=False),
    sa.Column('score', sa.Numeric(precision=3, scale=2), nullable=False),
    sa.CheckConstraint('score >= 0.0 AND score <= 1.0', name='score_range_check'),
    sa.ForeignKeyConstraint(['source_item_id'], ['source_item.id'], ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('id'),
    sa.UniqueConstraint('source_item_id', 'confidence_type', name='unique_source_confidence_type')
    )
    op.create_index('confidence_score_idx', 'confidence_score', ['score'], unique=False)
    op.create_index('confidence_source_idx', 'confidence_score', ['source_item_id'], unique=False)
    op.create_index('confidence_type_idx', 'confidence_score', ['confidence_type'], unique=False)
    op.create_table('discord_channels',
    sa.Column('id', sa.BigInteger(), nullable=False),
    sa.Column('server_id', sa.BigInteger(), nullable=True),
    sa.Column('category_id', sa.BigInteger(), nullable=True),
    sa.Column('name', sa.Text(), nullable=False),
    sa.Column('channel_type', sa.Text(), nullable=False),
    sa.Column('collect_messages', sa.Boolean(), nullable=True),
    sa.Column('project_id', sa.BigInteger(), nullable=True),
    sa.Column('sensitivity', sa.String(length=20), server_default='basic', nullable=False),
    sa.Column('config_version', sa.Integer(), server_default='1', nullable=False),
    sa.Column('created_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=True),
    sa.Column('updated_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=True),
    sa.ForeignKeyConstraint(['project_id'], ['projects.id'], ondelete='SET NULL'),
    sa.ForeignKeyConstraint(['server_id'], ['discord_servers.id'], ondelete='SET NULL'),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_index('discord_channels_category_idx', 'discord_channels', ['category_id'], unique=False)
    op.create_index('discord_channels_project_idx', 'discord_channels', ['project_id'], unique=False)
    op.create_index('discord_channels_server_idx', 'discord_channels', ['server_id'], unique=False)
    op.create_table('forum_post',
    sa.Column('id', sa.BigInteger(), nullable=False),
    sa.Column('url', sa.Text(), nullable=True),
    sa.Column('title', sa.Text(), nullable=True),
    sa.Column('description', sa.Text(), nullable=True),
    sa.Column('authors', sa.ARRAY(sa.Text()), nullable=True),
    sa.Column('published_at', sa.DateTime(timezone=True), nullable=True),
    sa.Column('modified_at', sa.DateTime(timezone=True), nullable=True),
    sa.Column('slug', sa.Text(), nullable=True),
    sa.Column('karma', sa.Integer(), nullable=True),
    sa.Column('votes', sa.Integer(), nullable=True),
    sa.Column('comments', sa.Integer(), nullable=True),
    sa.Column('words', sa.Integer(), nullable=True),
    sa.Column('score', sa.Integer(), nullable=True),
    sa.Column('images', sa.ARRAY(sa.Text()), nullable=True),
    sa.ForeignKeyConstraint(['id'], ['source_item.id'], ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('id'),
    sa.UniqueConstraint('url')
    )
    op.create_index('forum_post_slug_idx', 'forum_post', ['slug'], unique=False)
    op.create_index('forum_post_title_idx', 'forum_post', ['title'], unique=False)
    op.create_index('forum_post_url_idx', 'forum_post', ['url'], unique=False)
    op.create_table('git_commit',
    sa.Column('id', sa.BigInteger(), nullable=False),
    sa.Column('repo_path', sa.Text(), nullable=True),
    sa.Column('commit_sha', sa.Text(), nullable=True),
    sa.Column('author_name', sa.Text(), nullable=True),
    sa.Column('author_email', sa.Text(), nullable=True),
    sa.Column('author_date', sa.DateTime(timezone=True), nullable=True),
    sa.Column('diff_summary', sa.Text(), nullable=True),
    sa.Column('files_changed', sa.ARRAY(sa.Text()), nullable=True),
    sa.ForeignKeyConstraint(['id'], ['source_item.id'], ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('id'),
    sa.UniqueConstraint('commit_sha')
    )
    op.create_index('git_date_idx', 'git_commit', ['author_date'], unique=False)
    op.create_index('git_files_idx', 'git_commit', ['files_changed'], unique=False, postgresql_using='gin')
    op.create_table('github_item',
    sa.Column('id', sa.BigInteger(), nullable=False),
    sa.Column('kind', sa.Text(), nullable=False),
    sa.Column('repo_path', sa.Text(), nullable=False),
    sa.Column('number', sa.Integer(), nullable=True),
    sa.Column('parent_number', sa.Integer(), nullable=True),
    sa.Column('commit_sha', sa.Text(), nullable=True),
    sa.Column('state', sa.Text(), nullable=True),
    sa.Column('title', sa.Text(), nullable=True),
    sa.Column('labels', sa.ARRAY(sa.Text()), nullable=True),
    sa.Column('author', sa.Text(), nullable=True),
    sa.Column('created_at', sa.DateTime(timezone=True), nullable=True),
    sa.Column('closed_at', sa.DateTime(timezone=True), nullable=True),
    sa.Column('merged_at', sa.DateTime(timezone=True), nullable=True),
    sa.Column('diff_summary', sa.Text(), nullable=True),
    sa.Column('payload', postgresql.JSONB(astext_type=sa.Text()), nullable=True),
    sa.Column('github_updated_at', sa.DateTime(timezone=True), nullable=True),
    sa.Column('content_hash', sa.Text(), nullable=True),
    sa.Column('repo_id', sa.BigInteger(), nullable=True),
    sa.Column('project_status', sa.Text(), nullable=True),
    sa.Column('project_priority', sa.Text(), nullable=True),
    sa.Column('project_fields', postgresql.JSONB(astext_type=sa.Text()), nullable=True),
    sa.Column('assignees', sa.ARRAY(sa.Text()), nullable=True),
    sa.Column('milestone_id', sa.BigInteger(), nullable=True),
    sa.Column('comment_count', sa.Integer(), nullable=True),
    sa.CheckConstraint("kind IN ('issue', 'pr', 'comment', 'project_card')"),
    sa.ForeignKeyConstraint(['id'], ['source_item.id'], ondelete='CASCADE'),
    sa.ForeignKeyConstraint(['milestone_id'], ['projects.id'], ondelete='SET NULL'),
    sa.ForeignKeyConstraint(['repo_id'], ['github_repos.id'], ondelete='SET NULL'),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_index('gh_github_updated_at_idx', 'github_item', ['github_updated_at'], unique=False)
    op.create_index('gh_issue_lookup_idx', 'github_item', ['repo_path', 'kind', 'number'], unique=False)
    op.create_index('gh_labels_idx', 'github_item', ['labels'], unique=False, postgresql_using='gin')
    op.create_index('gh_milestone_id_idx', 'github_item', ['milestone_id'], unique=False)
    op.create_index('gh_repo_id_idx', 'github_item', ['repo_id'], unique=False)
    op.create_index('gh_repo_kind_idx', 'github_item', ['repo_path', 'kind'], unique=False)
    op.create_table('google_doc',
    sa.Column('id', sa.BigInteger(), nullable=False),
    sa.Column('google_file_id', sa.Text(), nullable=False),
    sa.Column('google_modified_at', sa.DateTime(timezone=True), nullable=True),
    sa.Column('title', sa.Text(), nullable=False),
    sa.Column('original_mime_type', sa.Text(), nullable=True),
    sa.Column('folder_id', sa.BigInteger(), nullable=True),
    sa.Column('folder_path', sa.Text(), nullable=True),
    sa.Column('owner', sa.Text(), nullable=True),
    sa.Column('last_modified_by', sa.Text(), nullable=True),
    sa.Column('word_count', sa.Integer(), nullable=True),
    sa.Column('content_hash', sa.Text(), nullable=True),
    sa.ForeignKeyConstraint(['folder_id'], ['google_folders.id'], ondelete='SET NULL'),
    sa.ForeignKeyConstraint(['id'], ['source_item.id'], ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('id'),
    sa.UniqueConstraint('google_file_id')
    )
    op.create_index('google_doc_file_id_idx', 'google_doc', ['google_file_id'], unique=True)
    op.create_index('google_doc_folder_idx', 'google_doc', ['folder_id'], unique=False)
    op.create_index('google_doc_modified_idx', 'google_doc', ['google_modified_at'], unique=False)
    op.create_index('google_doc_title_idx', 'google_doc', ['title'], unique=False)
    op.create_table('mail_message',
    sa.Column('id', sa.BigInteger(), nullable=False),
    sa.Column('message_id', sa.Text(), nullable=True),
    sa.Column('subject', sa.Text(), nullable=True),
    sa.Column('sender', sa.Text(), nullable=True),
    sa.Column('recipients', sa.ARRAY(sa.Text()), nullable=True),
    sa.Column('sent_at', sa.DateTime(timezone=True), nullable=True),
    sa.Column('folder', sa.Text(), nullable=True),
    sa.Column('tsv', postgresql.TSVECTOR(), nullable=True),
    sa.Column('email_account_id', sa.BigInteger(), nullable=True),
    sa.Column('imap_uid', sa.Text(), nullable=True),
    sa.ForeignKeyConstraint(['email_account_id'], ['email_accounts.id'], ondelete='CASCADE'),
    sa.ForeignKeyConstraint(['id'], ['source_item.id'], ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('id'),
    sa.UniqueConstraint('message_id')
    )
    op.create_index('mail_account_idx', 'mail_message', ['email_account_id'], unique=False)
    op.create_index('mail_imap_uid_idx', 'mail_message', ['email_account_id', 'folder', 'imap_uid'], unique=False)
    op.create_index('mail_recipients_idx', 'mail_message', ['recipients'], unique=False, postgresql_using='gin')
    op.create_index('mail_sent_idx', 'mail_message', ['sent_at'], unique=False)
    op.create_index('mail_tsv_idx', 'mail_message', ['tsv'], unique=False, postgresql_using='gin')
    op.create_table('misc_doc',
    sa.Column('id', sa.BigInteger(), nullable=False),
    sa.Column('path', sa.Text(), nullable=True),
    sa.ForeignKeyConstraint(['id'], ['source_item.id'], ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_table('notes',
    sa.Column('id', sa.BigInteger(), nullable=False),
    sa.Column('note_type', sa.Text(), nullable=True),
    sa.Column('subject', sa.Text(), nullable=True),
    sa.ForeignKeyConstraint(['id'], ['source_item.id'], ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_index('note_subject_idx', 'notes', ['subject'], unique=False)
    op.create_index('note_type_idx', 'notes', ['note_type'], unique=False)
    op.create_table('people',
    sa.Column('id', sa.BigInteger(), nullable=False),
    sa.Column('identifier', sa.Text(), nullable=False),
    sa.Column('display_name', sa.Text(), nullable=False),
    sa.Column('aliases', sa.ARRAY(sa.Text()), server_default='{}', nullable=False),
    sa.Column('contact_info', postgresql.JSONB(astext_type=sa.Text()), server_default='{}', nullable=False),
    sa.Column('user_id', sa.BigInteger(), nullable=True),
    sa.ForeignKeyConstraint(['id'], ['source_item.id'], ondelete='CASCADE'),
    sa.ForeignKeyConstraint(['user_id'], ['users.id'], ondelete='SET NULL'),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_index(op.f('ix_people_identifier'), 'people', ['identifier'], unique=True)
    op.create_index('person_aliases_idx', 'people', ['aliases'], unique=False, postgresql_using='gin')
    op.create_index('person_display_name_idx', 'people', ['display_name'], unique=False)
    op.create_index('person_identifier_idx', 'people', ['identifier'], unique=False)
    op.create_table('photo',
    sa.Column('id', sa.BigInteger(), nullable=False),
    sa.Column('exif_taken_at', sa.DateTime(timezone=True), nullable=True),
    sa.Column('exif_lat', sa.Numeric(precision=9, scale=6), nullable=True),
    sa.Column('exif_lon', sa.Numeric(precision=9, scale=6), nullable=True),
    sa.Column('camera', sa.Text(), nullable=True),
    sa.ForeignKeyConstraint(['id'], ['source_item.id'], ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_index('photo_taken_idx', 'photo', ['exif_taken_at'], unique=False)
    op.create_table('slack_channels',
    sa.Column('id', sa.Text(), nullable=False),
    sa.Column('workspace_id', sa.Text(), nullable=False),
    sa.Column('name', sa.Text(), nullable=False),
    sa.Column('channel_type', sa.Text(), nullable=False),
    sa.Column('is_private', sa.Boolean(), nullable=False),
    sa.Column('is_archived', sa.Boolean(), nullable=False),
    sa.Column('collect_messages', sa.Boolean(), nullable=True),
    sa.Column('project_id', sa.BigInteger(), nullable=True),
    sa.Column('sensitivity', sa.String(length=20), server_default='basic', nullable=False),
    sa.Column('config_version', sa.Integer(), server_default='1', nullable=False),
    sa.Column('last_message_ts', sa.Text(), nullable=True),
    sa.Column('created_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=True),
    sa.Column('updated_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=True),
    sa.ForeignKeyConstraint(['project_id'], ['projects.id'], ondelete='SET NULL'),
    sa.ForeignKeyConstraint(['workspace_id'], ['slack_workspaces.id'], ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_index('slack_channels_project_idx', 'slack_channels', ['project_id'], unique=False)
    op.create_index('slack_channels_type_idx', 'slack_channels', ['channel_type'], unique=False)
    op.create_index('slack_channels_workspace_idx', 'slack_channels', ['workspace_id'], unique=False)
    op.create_table('slack_user_credentials',
    sa.Column('id', sa.Integer(), autoincrement=True, nullable=False),
    sa.Column('workspace_id', sa.Text(), nullable=False),
    sa.Column('user_id', sa.Integer(), nullable=False),
    sa.Column('access_token_encrypted', sa.LargeBinary(), nullable=True),
    sa.Column('refresh_token_encrypted', sa.LargeBinary(), nullable=True),
    sa.Column('token_expires_at', sa.DateTime(timezone=True), nullable=True),
    sa.Column('scopes', postgresql.ARRAY(sa.Text()), nullable=True),
    sa.Column('slack_user_id', sa.Text(), nullable=True),
    sa.Column('created_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=True),
    sa.Column('updated_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=True),
    sa.ForeignKeyConstraint(['user_id'], ['users.id'], ondelete='CASCADE'),
    sa.ForeignKeyConstraint(['workspace_id'], ['slack_workspaces.id'], ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('id'),
    sa.UniqueConstraint('workspace_id', 'user_id', name='unique_slack_credential_per_user')
    )
    op.create_index('slack_credentials_user_idx', 'slack_user_credentials', ['user_id'], unique=False)
    op.create_index('slack_credentials_workspace_idx', 'slack_user_credentials', ['workspace_id'], unique=False)
    op.create_table('task',
    sa.Column('id', sa.BigInteger(), nullable=False),
    sa.Column('task_title', sa.Text(), nullable=False),
    sa.Column('due_date', sa.DateTime(timezone=True), nullable=True),
    sa.Column('priority', sa.Text(), nullable=True),
    sa.Column('status', sa.Text(), server_default='pending', nullable=False),
    sa.Column('recurrence', sa.Text(), nullable=True),
    sa.Column('completed_at', sa.DateTime(timezone=True), nullable=True),
    sa.Column('source_item_id', sa.BigInteger(), nullable=True),
    sa.CheckConstraint("priority IS NULL OR priority IN ('low', 'medium', 'high', 'urgent')", name='task_priority_check'),
    sa.CheckConstraint("status IN ('pending', 'in_progress', 'done', 'cancelled')", name='task_status_check'),
    sa.ForeignKeyConstraint(['id'], ['source_item.id'], ondelete='CASCADE'),
    sa.ForeignKeyConstraint(['source_item_id'], ['source_item.id'], ondelete='SET NULL'),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_index('task_due_date_idx', 'task', ['due_date'], unique=False)
    op.create_index('task_priority_idx', 'task', ['priority'], unique=False)
    op.create_index('task_source_item_idx', 'task', ['source_item_id'], unique=False)
    op.create_index('task_status_idx', 'task', ['status'], unique=False)
    op.create_table('discord_users',
    sa.Column('id', sa.BigInteger(), nullable=False),
    sa.Column('username', sa.Text(), nullable=False),
    sa.Column('display_name', sa.Text(), nullable=True),
    sa.Column('system_user_id', sa.Integer(), nullable=True),
    sa.Column('person_id', sa.BigInteger(), nullable=True),
    sa.Column('created_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=True),
    sa.Column('updated_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=True),
    sa.ForeignKeyConstraint(['person_id'], ['people.id'], ondelete='SET NULL'),
    sa.ForeignKeyConstraint(['system_user_id'], ['users.id'], ondelete='SET NULL'),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_index('discord_users_person_idx', 'discord_users', ['person_id'], unique=False)
    op.create_index('discord_users_system_user_idx', 'discord_users', ['system_user_id'], unique=False)
    op.create_table('email_attachment',
    sa.Column('id', sa.BigInteger(), nullable=False),
    sa.Column('mail_message_id', sa.BigInteger(), nullable=False),
    sa.Column('created_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=True),
    sa.ForeignKeyConstraint(['id'], ['source_item.id'], ondelete='CASCADE'),
    sa.ForeignKeyConstraint(['mail_message_id'], ['mail_message.id'], ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_index('email_attachment_message_idx', 'email_attachment', ['mail_message_id'], unique=False)
    op.create_table('github_pr_data',
    sa.Column('id', sa.BigInteger(), nullable=False),
    sa.Column('github_item_id', sa.BigInteger(), nullable=False),
    sa.Column('diff_compressed', sa.LargeBinary(), nullable=True),
    sa.Column('files', postgresql.JSONB(astext_type=sa.Text()), nullable=True),
    sa.Column('additions', sa.Integer(), nullable=True),
    sa.Column('deletions', sa.Integer(), nullable=True),
    sa.Column('changed_files_count', sa.Integer(), nullable=True),
    sa.Column('reviews', postgresql.JSONB(astext_type=sa.Text()), nullable=True),
    sa.Column('review_comments', postgresql.JSONB(astext_type=sa.Text()), nullable=True),
    sa.ForeignKeyConstraint(['github_item_id'], ['github_item.id'], ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_index(op.f('ix_github_pr_data_github_item_id'), 'github_pr_data', ['github_item_id'], unique=True)
    op.create_table('github_users',
    sa.Column('id', sa.BigInteger(), nullable=False),
    sa.Column('username', sa.String(length=100), nullable=False),
    sa.Column('display_name', sa.String(length=255), nullable=True),
    sa.Column('avatar_url', sa.Text(), nullable=True),
    sa.Column('email', sa.String(length=255), nullable=True),
    sa.Column('person_id', sa.BigInteger(), nullable=True),
    sa.Column('created_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False),
    sa.Column('updated_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False),
    sa.ForeignKeyConstraint(['person_id'], ['people.id'], ondelete='SET NULL'),
    sa.PrimaryKeyConstraint('id'),
    sa.UniqueConstraint('username')
    )
    op.create_index('github_users_person_idx', 'github_users', ['person_id'], unique=False)
    op.create_index('github_users_username_idx', 'github_users', ['username'], unique=False)
    op.create_table('meeting',
    sa.Column('id', sa.BigInteger(), nullable=False),
    sa.Column('title', sa.Text(), nullable=True),
    sa.Column('meeting_date', sa.DateTime(timezone=True), nullable=True),
    sa.Column('duration_minutes', sa.Integer(), nullable=True),
    sa.Column('source_tool', sa.Text(), nullable=True),
    sa.Column('external_id', sa.Text(), nullable=True),
    sa.Column('calendar_event_id', sa.BigInteger(), nullable=True),
    sa.Column('summary', sa.Text(), nullable=True),
    sa.Column('notes', sa.Text(), nullable=True),
    sa.Column('extraction_status', sa.Text(), server_default='pending', nullable=False),
    sa.ForeignKeyConstraint(['calendar_event_id'], ['calendar_event.id'], ondelete='SET NULL'),
    sa.ForeignKeyConstraint(['id'], ['source_item.id'], ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_index('meeting_calendar_event_idx', 'meeting', ['calendar_event_id'], unique=False)
    op.create_index('meeting_date_idx', 'meeting', ['meeting_date'], unique=False)
    op.create_index('meeting_external_id_idx', 'meeting', ['external_id'], unique=True, postgresql_where=sa.text('external_id IS NOT NULL'))
    op.create_index('meeting_extraction_status_idx', 'meeting', ['extraction_status'], unique=False)
    op.create_index('meeting_source_tool_idx', 'meeting', ['source_tool'], unique=False)
    op.create_table('observation_contradiction',
    sa.Column('id', sa.BigInteger(), nullable=False),
    sa.Column('observation_1_id', sa.BigInteger(), nullable=False),
    sa.Column('observation_2_id', sa.BigInteger(), nullable=False),
    sa.Column('contradiction_type', sa.Text(), nullable=False),
    sa.Column('detected_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=True),
    sa.Column('detection_method', sa.Text(), nullable=False),
    sa.Column('resolution', sa.Text(), nullable=True),
    sa.Column('observation_metadata', postgresql.JSONB(astext_type=sa.Text()), nullable=True),
    sa.ForeignKeyConstraint(['observation_1_id'], ['agent_observation.id'], ondelete='CASCADE'),
    sa.ForeignKeyConstraint(['observation_2_id'], ['agent_observation.id'], ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_index('obs_contra_method_idx', 'observation_contradiction', ['detection_method'], unique=False)
    op.create_index('obs_contra_obs1_idx', 'observation_contradiction', ['observation_1_id'], unique=False)
    op.create_index('obs_contra_obs2_idx', 'observation_contradiction', ['observation_2_id'], unique=False)
    op.create_index('obs_contra_type_idx', 'observation_contradiction', ['contradiction_type'], unique=False)
    op.create_table('poll_responses',
    sa.Column('id', sa.BigInteger(), autoincrement=True, nullable=False),
    sa.Column('poll_id', sa.BigInteger(), nullable=False),
    sa.Column('respondent_name', sa.String(length=255), nullable=True),
    sa.Column('respondent_email', sa.String(length=255), nullable=True),
    sa.Column('person_id', sa.BigInteger(), nullable=True),
    sa.Column('edit_token', sa.String(length=32), nullable=False),
    sa.Column('created_at', sa.DateTime(timezone=True), nullable=False),
    sa.Column('updated_at', sa.DateTime(timezone=True), nullable=False),
    sa.ForeignKeyConstraint(['person_id'], ['people.id'], ondelete='SET NULL'),
    sa.ForeignKeyConstraint(['poll_id'], ['availability_polls.id'], ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_index('idx_poll_responses_edit_token', 'poll_responses', ['edit_token'], unique=False)
    op.create_index('idx_poll_responses_person_id', 'poll_responses', ['person_id'], unique=False)
    op.create_index('idx_poll_responses_poll_id', 'poll_responses', ['poll_id'], unique=False)
    op.create_table('project_collaborators',
    sa.Column('project_id', sa.BigInteger(), nullable=False),
    sa.Column('person_id', sa.BigInteger(), nullable=False),
    sa.Column('role', sa.String(length=50), server_default='contributor', nullable=False),
    sa.CheckConstraint("role IN ('contributor', 'manager', 'admin')", name='valid_collaborator_role'),
    sa.ForeignKeyConstraint(['person_id'], ['people.id'], ondelete='CASCADE'),
    sa.ForeignKeyConstraint(['project_id'], ['projects.id'], ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('project_id', 'person_id')
    )
    op.create_index('project_collaborators_person_idx', 'project_collaborators', ['person_id'], unique=False)
    op.create_index('project_collaborators_project_idx', 'project_collaborators', ['project_id'], unique=False)
    op.create_table('slack_message',
    sa.Column('id', sa.BigInteger(), nullable=False),
    sa.Column('message_ts', sa.Text(), nullable=False),
    sa.Column('channel_id', sa.Text(), nullable=False),
    sa.Column('workspace_id', sa.Text(), nullable=False),
    sa.Column('author_id', sa.Text(), nullable=True),
    sa.Column('author_name', sa.Text(), nullable=True),
    sa.Column('thread_ts', sa.Text(), nullable=True),
    sa.Column('reply_count', sa.Integer(), nullable=True),
    sa.Column('message_type', sa.Text(), server_default='message', nullable=False),
    sa.Column('edited_ts', sa.Text(), nullable=True),
    sa.Column('reactions', postgresql.JSONB(astext_type=sa.Text()), nullable=True),
    sa.Column('files', postgresql.JSONB(astext_type=sa.Text()), nullable=True),
    sa.Column('resolved_content', sa.Text(), nullable=True),
    sa.Column('images', sa.ARRAY(sa.Text()), nullable=True),
    sa.ForeignKeyConstraint(['channel_id'], ['slack_channels.id'], ondelete='CASCADE'),
    sa.ForeignKeyConstraint(['id'], ['source_item.id'], ondelete='CASCADE'),
    sa.ForeignKeyConstraint(['workspace_id'], ['slack_workspaces.id'], ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_index('slack_message_author_idx', 'slack_message', ['author_id'], unique=False)
    op.create_index('slack_message_channel_idx', 'slack_message', ['channel_id'], unique=False)
    op.create_index('slack_message_thread_idx', 'slack_message', ['thread_ts'], unique=False)
    op.create_index('slack_message_ts_workspace_channel_idx', 'slack_message', ['message_ts', 'workspace_id', 'channel_id'], unique=True)
    op.create_index('slack_message_workspace_idx', 'slack_message', ['workspace_id'], unique=False)
    op.create_table('source_item_people',
    sa.Column('source_item_id', sa.BigInteger(), nullable=False),
    sa.Column('person_id', sa.BigInteger(), nullable=False),
    sa.ForeignKeyConstraint(['person_id'], ['people.id'], ondelete='CASCADE'),
    sa.ForeignKeyConstraint(['source_item_id'], ['source_item.id'], ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('source_item_id', 'person_id')
    )
    op.create_index('source_item_people_person_idx', 'source_item_people', ['person_id'], unique=False)
    op.create_index('source_item_people_source_idx', 'source_item_people', ['source_item_id'], unique=False)
    op.create_table('discord_message',
    sa.Column('id', sa.BigInteger(), nullable=False),
    sa.Column('message_id', sa.BigInteger(), nullable=False),
    sa.Column('channel_id', sa.BigInteger(), nullable=False),
    sa.Column('server_id', sa.BigInteger(), nullable=True),
    sa.Column('author_id', sa.BigInteger(), nullable=False),
    sa.Column('bot_id', sa.BigInteger(), nullable=True),
    sa.Column('sent_at', sa.DateTime(timezone=True), nullable=False),
    sa.Column('edited_at', sa.DateTime(timezone=True), nullable=True),
    sa.Column('reply_to_message_id', sa.BigInteger(), nullable=True),
    sa.Column('thread_id', sa.BigInteger(), nullable=True),
    sa.Column('message_type', sa.Text(), server_default='default', nullable=False),
    sa.Column('is_pinned', sa.Boolean(), nullable=False),
    sa.Column('images', sa.ARRAY(sa.Text()), nullable=True),
    sa.Column('reactions', postgresql.JSONB(astext_type=sa.Text()), nullable=True),
    sa.Column('embeds', postgresql.JSONB(astext_type=sa.Text()), nullable=True),
    sa.Column('attachments', postgresql.JSONB(astext_type=sa.Text()), nullable=True),
    sa.ForeignKeyConstraint(['author_id'], ['discord_users.id'], ),
    sa.ForeignKeyConstraint(['bot_id'], ['discord_bots.id'], ),
    sa.ForeignKeyConstraint(['channel_id'], ['discord_channels.id'], ),
    sa.ForeignKeyConstraint(['id'], ['source_item.id'], ondelete='CASCADE'),
    sa.ForeignKeyConstraint(['server_id'], ['discord_servers.id'], ),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_index('discord_message_author_idx', 'discord_message', ['author_id'], unique=False)
    op.create_index('discord_message_bot_idx', 'discord_message', ['bot_id'], unique=False)
    op.create_index('discord_message_channel_idx', 'discord_message', ['channel_id', 'sent_at'], unique=False)
    op.create_index('discord_message_discord_id_idx', 'discord_message', ['message_id'], unique=True)
    op.create_table('poll_availabilities',
    sa.Column('id', sa.BigInteger(), autoincrement=True, nullable=False),
    sa.Column('response_id', sa.BigInteger(), nullable=False),
    sa.Column('slot_start', sa.DateTime(timezone=True), nullable=False),
    sa.Column('slot_end', sa.DateTime(timezone=True), nullable=False),
    sa.Column('availability_level', sa.Integer(), nullable=False),
    sa.ForeignKeyConstraint(['response_id'], ['poll_responses.id'], ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_index('idx_poll_availability_response_id', 'poll_availabilities', ['response_id'], unique=False)
    op.create_index('idx_poll_availability_slots', 'poll_availabilities', ['slot_start', 'slot_end'], unique=False)
    op.create_table('scheduled_llm_calls',
    sa.Column('id', sa.String(), nullable=False),
    sa.Column('user_id', sa.Integer(), nullable=False),
    sa.Column('topic', sa.Text(), nullable=True),
    sa.Column('scheduled_time', sa.DateTime(), nullable=False),
    sa.Column('created_at', sa.DateTime(), server_default=sa.text('now()'), nullable=True),
    sa.Column('executed_at', sa.DateTime(), nullable=True),
    sa.Column('model', sa.String(), nullable=True),
    sa.Column('message', sa.Text(), nullable=False),
    sa.Column('system_prompt', sa.Text(), nullable=True),
    sa.Column('allowed_tools', sa.JSON(), nullable=True),
    sa.Column('discord_channel_id', sa.BigInteger(), nullable=True),
    sa.Column('discord_user_id', sa.BigInteger(), nullable=True),
    sa.Column('status', sa.String(), nullable=False),
    sa.Column('response', sa.Text(), nullable=True),
    sa.Column('error_message', sa.Text(), nullable=True),
    sa.Column('data', sa.JSON(), nullable=True),
    sa.Column('celery_task_id', sa.String(), nullable=True),
    sa.ForeignKeyConstraint(['discord_channel_id'], ['discord_channels.id'], ),
    sa.ForeignKeyConstraint(['discord_user_id'], ['discord_users.id'], ),
    sa.ForeignKeyConstraint(['user_id'], ['users.id'], ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('id')
    )
    # ### end Alembic commands ###


def downgrade() -> None:
    # ### commands auto generated by Alembic - please adjust! ###
    op.drop_table('scheduled_llm_calls')
    op.drop_index('idx_poll_availability_slots', table_name='poll_availabilities')
    op.drop_index('idx_poll_availability_response_id', table_name='poll_availabilities')
    op.drop_table('poll_availabilities')
    op.drop_index('discord_message_discord_id_idx', table_name='discord_message')
    op.drop_index('discord_message_channel_idx', table_name='discord_message')
    op.drop_index('discord_message_bot_idx', table_name='discord_message')
    op.drop_index('discord_message_author_idx', table_name='discord_message')
    op.drop_table('discord_message')
    op.drop_index('source_item_people_source_idx', table_name='source_item_people')
    op.drop_index('source_item_people_person_idx', table_name='source_item_people')
    op.drop_table('source_item_people')
    op.drop_index('slack_message_workspace_idx', table_name='slack_message')
    op.drop_index('slack_message_ts_workspace_channel_idx', table_name='slack_message')
    op.drop_index('slack_message_thread_idx', table_name='slack_message')
    op.drop_index('slack_message_channel_idx', table_name='slack_message')
    op.drop_index('slack_message_author_idx', table_name='slack_message')
    op.drop_table('slack_message')
    op.drop_index('project_collaborators_project_idx', table_name='project_collaborators')
    op.drop_index('project_collaborators_person_idx', table_name='project_collaborators')
    op.drop_table('project_collaborators')
    op.drop_index('idx_poll_responses_poll_id', table_name='poll_responses')
    op.drop_index('idx_poll_responses_person_id', table_name='poll_responses')
    op.drop_index('idx_poll_responses_edit_token', table_name='poll_responses')
    op.drop_table('poll_responses')
    op.drop_index('obs_contra_type_idx', table_name='observation_contradiction')
    op.drop_index('obs_contra_obs2_idx', table_name='observation_contradiction')
    op.drop_index('obs_contra_obs1_idx', table_name='observation_contradiction')
    op.drop_index('obs_contra_method_idx', table_name='observation_contradiction')
    op.drop_table('observation_contradiction')
    op.drop_index('meeting_source_tool_idx', table_name='meeting')
    op.drop_index('meeting_extraction_status_idx', table_name='meeting')
    op.drop_index('meeting_external_id_idx', table_name='meeting', postgresql_where=sa.text('external_id IS NOT NULL'))
    op.drop_index('meeting_date_idx', table_name='meeting')
    op.drop_index('meeting_calendar_event_idx', table_name='meeting')
    op.drop_table('meeting')
    op.drop_index('github_users_username_idx', table_name='github_users')
    op.drop_index('github_users_person_idx', table_name='github_users')
    op.drop_table('github_users')
    op.drop_index(op.f('ix_github_pr_data_github_item_id'), table_name='github_pr_data')
    op.drop_table('github_pr_data')
    op.drop_index('email_attachment_message_idx', table_name='email_attachment')
    op.drop_table('email_attachment')
    op.drop_index('discord_users_system_user_idx', table_name='discord_users')
    op.drop_index('discord_users_person_idx', table_name='discord_users')
    op.drop_table('discord_users')
    op.drop_index('task_status_idx', table_name='task')
    op.drop_index('task_source_item_idx', table_name='task')
    op.drop_index('task_priority_idx', table_name='task')
    op.drop_index('task_due_date_idx', table_name='task')
    op.drop_table('task')
    op.drop_index('slack_credentials_workspace_idx', table_name='slack_user_credentials')
    op.drop_index('slack_credentials_user_idx', table_name='slack_user_credentials')
    op.drop_table('slack_user_credentials')
    op.drop_index('slack_channels_workspace_idx', table_name='slack_channels')
    op.drop_index('slack_channels_type_idx', table_name='slack_channels')
    op.drop_index('slack_channels_project_idx', table_name='slack_channels')
    op.drop_table('slack_channels')
    op.drop_index('photo_taken_idx', table_name='photo')
    op.drop_table('photo')
    op.drop_index('person_identifier_idx', table_name='people')
    op.drop_index('person_display_name_idx', table_name='people')
    op.drop_index('person_aliases_idx', table_name='people', postgresql_using='gin')
    op.drop_index(op.f('ix_people_identifier'), table_name='people')
    op.drop_table('people')
    op.drop_index('note_type_idx', table_name='notes')
    op.drop_index('note_subject_idx', table_name='notes')
    op.drop_table('notes')
    op.drop_table('misc_doc')
    op.drop_index('mail_tsv_idx', table_name='mail_message', postgresql_using='gin')
    op.drop_index('mail_sent_idx', table_name='mail_message')
    op.drop_index('mail_recipients_idx', table_name='mail_message', postgresql_using='gin')
    op.drop_index('mail_imap_uid_idx', table_name='mail_message')
    op.drop_index('mail_account_idx', table_name='mail_message')
    op.drop_table('mail_message')
    op.drop_index('google_doc_title_idx', table_name='google_doc')
    op.drop_index('google_doc_modified_idx', table_name='google_doc')
    op.drop_index('google_doc_folder_idx', table_name='google_doc')
    op.drop_index('google_doc_file_id_idx', table_name='google_doc')
    op.drop_table('google_doc')
    op.drop_index('gh_repo_kind_idx', table_name='github_item')
    op.drop_index('gh_repo_id_idx', table_name='github_item')
    op.drop_index('gh_milestone_id_idx', table_name='github_item')
    op.drop_index('gh_labels_idx', table_name='github_item', postgresql_using='gin')
    op.drop_index('gh_issue_lookup_idx', table_name='github_item')
    op.drop_index('gh_github_updated_at_idx', table_name='github_item')
    op.drop_table('github_item')
    op.drop_index('git_files_idx', table_name='git_commit', postgresql_using='gin')
    op.drop_index('git_date_idx', table_name='git_commit')
    op.drop_table('git_commit')
    op.drop_index('forum_post_url_idx', table_name='forum_post')
    op.drop_index('forum_post_title_idx', table_name='forum_post')
    op.drop_index('forum_post_slug_idx', table_name='forum_post')
    op.drop_table('forum_post')
    op.drop_index('discord_channels_server_idx', table_name='discord_channels')
    op.drop_index('discord_channels_project_idx', table_name='discord_channels')
    op.drop_index('discord_channels_category_idx', table_name='discord_channels')
    op.drop_table('discord_channels')
    op.drop_index('confidence_type_idx', table_name='confidence_score')
    op.drop_index('confidence_source_idx', table_name='confidence_score')
    op.drop_index('confidence_score_idx', table_name='confidence_score')
    op.drop_table('confidence_score')
    op.drop_index('comic_author_idx', table_name='comic')
    op.drop_table('comic')
    op.drop_index('chunk_source_idx', table_name='chunk')
    op.drop_index('chunk_collection_idx', table_name='chunk')
    op.drop_table('chunk')
    op.drop_index('chat_channel_idx', table_name='chat_message')
    op.drop_table('chat_message')
    op.drop_index('calendar_event_start_idx', table_name='calendar_event')
    op.drop_index('calendar_event_external_idx', table_name='calendar_event', postgresql_where='external_id IS NOT NULL')
    op.drop_index('calendar_event_end_idx', table_name='calendar_event')
    op.drop_index('calendar_event_calendar_idx', table_name='calendar_event')
    op.drop_index('calendar_event_account_idx', table_name='calendar_event')
    op.drop_table('calendar_event')
    op.drop_index('book_section_parent_idx', table_name='book_section')
    op.drop_index('book_section_level_idx', table_name='book_section')
    op.drop_index('book_section_book_idx', table_name='book_section')
    op.drop_table('book_section')
    op.drop_index('blog_post_word_count_idx', table_name='blog_post')
    op.drop_index('blog_post_published_idx', table_name='blog_post')
    op.drop_index('blog_post_feed_idx', table_name='blog_post')
    op.drop_index('blog_post_domain_idx', table_name='blog_post')
    op.drop_index('blog_post_author_idx', table_name='blog_post')
    op.drop_table('blog_post')
    op.drop_index('agent_obs_type_idx', table_name='agent_observation')
    op.drop_index('agent_obs_subject_idx', table_name='agent_observation')
    op.drop_index('agent_obs_session_idx', table_name='agent_observation')
    op.drop_index('agent_obs_model_idx', table_name='agent_observation')
    op.drop_table('agent_observation')
    op.drop_index('source_verified_at_idx', table_name='source_item')
    op.drop_index('source_tags_idx', table_name='source_item', postgresql_using='gin')
    op.drop_index('source_status_idx', table_name='source_item')
    op.drop_index('source_sensitivity_idx', table_name='source_item')
    op.drop_index('source_project_idx', table_name='source_item')
    op.drop_index('source_modality_idx', table_name='source_item')
    op.drop_index('source_filename_idx', table_name='source_item')
    op.drop_table('source_item')
    op.drop_index('slack_workspaces_project_idx', table_name='slack_workspaces')
    op.drop_index('slack_workspaces_collect_idx', table_name='slack_workspaces')
    op.drop_table('slack_workspaces')
    op.drop_index('google_folders_project_idx', table_name='google_folders')
    op.drop_index('google_folders_active_idx', table_name='google_folders')
    op.drop_table('google_folders')
    op.drop_index('email_accounts_user_idx', table_name='email_accounts')
    op.drop_index('email_accounts_type_idx', table_name='email_accounts')
    op.drop_index('email_accounts_tags_idx', table_name='email_accounts', postgresql_using='gin')
    op.drop_index('email_accounts_project_idx', table_name='email_accounts')
    op.drop_index('email_accounts_address_idx', table_name='email_accounts')
    op.drop_index('email_accounts_active_idx', table_name='email_accounts')
    op.drop_table('email_accounts')
    op.drop_index('discord_servers_project_idx', table_name='discord_servers')
    op.drop_index('discord_servers_collect_idx', table_name='discord_servers')
    op.drop_table('discord_servers')
    op.drop_index('calendar_accounts_type_idx', table_name='calendar_accounts')
    op.drop_index('calendar_accounts_project_idx', table_name='calendar_accounts')
    op.drop_index('calendar_accounts_active_idx', table_name='calendar_accounts')
    op.drop_table('calendar_accounts')
    op.drop_index('article_feeds_tags_idx', table_name='article_feeds', postgresql_using='gin')
    op.drop_index('article_feeds_project_idx', table_name='article_feeds')
    op.drop_index('article_feeds_active_idx', table_name='article_feeds')
    op.drop_table('article_feeds')
    op.drop_index('unique_github_milestone_per_repo', table_name='projects', postgresql_where=sa.text('repo_id IS NOT NULL'))
    op.drop_index('projects_repo_idx', table_name='projects')
    op.drop_index('projects_parent_idx', table_name='projects')
    op.drop_index('projects_due_idx', table_name='projects')
    op.drop_table('projects')
    op.drop_table('oauth_refresh_tokens')
    op.drop_table('user_sessions')
    op.drop_index(op.f('ix_sessions_user_id'), table_name='sessions')
    op.drop_index(op.f('ix_sessions_parent_session_id'), table_name='sessions')
    op.drop_index(op.f('ix_sessions_coding_project_id'), table_name='sessions')
    op.drop_index('idx_sessions_user', table_name='sessions')
    op.drop_index('idx_sessions_started', table_name='sessions')
    op.drop_index('idx_sessions_source', table_name='sessions')
    op.drop_index('idx_sessions_parent', table_name='sessions')
    op.drop_index('idx_sessions_ended', table_name='sessions')
    op.drop_index('idx_sessions_coding_project', table_name='sessions')
    op.drop_table('sessions')
    op.drop_index('github_teams_slug_idx', table_name='github_teams')
    op.drop_index('github_teams_org_idx', table_name='github_teams')
    op.drop_table('github_teams')
    op.drop_index('github_repos_owner_name_idx', table_name='github_repos')
    op.drop_index('github_repos_active_idx', table_name='github_repos')
    op.drop_table('github_repos')
    op.drop_index('github_projects_title_idx', table_name='github_projects')
    op.drop_index('github_projects_owner_idx', table_name='github_projects')
    op.drop_table('github_projects')
    op.drop_index(op.f('ix_claude_environments_user_id'), table_name='claude_environments')
    op.drop_index('idx_environments_user', table_name='claude_environments')
    op.drop_table('claude_environments')
    op.drop_index('ix_watched_markets_user_id', table_name='watched_markets')
    op.drop_table('watched_markets')
    op.drop_index(op.f('ix_telemetry_events_user_id'), table_name='telemetry_events')
    op.drop_index(op.f('ix_telemetry_events_session_id'), table_name='telemetry_events')
    op.drop_index('idx_telemetry_events_user_ts', table_name='telemetry_events')
    op.drop_index('idx_telemetry_events_type_name', table_name='telemetry_events')
    op.drop_index('idx_telemetry_events_timestamp', table_name='telemetry_events')
    op.drop_index('idx_telemetry_events_source', table_name='telemetry_events')
    op.drop_index('idx_telemetry_events_session', table_name='telemetry_events')
    op.drop_index('idx_telemetry_events_name_ts', table_name='telemetry_events')
    op.drop_index('idx_telemetry_events_attrs', table_name='telemetry_events', postgresql_using='gin')
    op.drop_table('telemetry_events')
    op.drop_index(op.f('ix_secrets_name'), table_name='secrets')
    op.drop_table('secrets')
    op.drop_index('idx_pending_jobs_user_id', table_name='pending_jobs')
    op.drop_index('idx_pending_jobs_status', table_name='pending_jobs')
    op.drop_index('idx_pending_jobs_job_type', table_name='pending_jobs')
    op.drop_index('idx_pending_jobs_external_id', table_name='pending_jobs')
    op.drop_index('idx_pending_jobs_created_at', table_name='pending_jobs')
    op.drop_index('idx_pending_jobs_celery_task_id', table_name='pending_jobs')
    op.drop_table('pending_jobs')
    op.drop_table('oauth_states')
    op.drop_index(op.f('ix_oauth_client_states_state'), table_name='oauth_client_states')
    op.drop_index(op.f('ix_oauth_client_states_provider'), table_name='oauth_client_states')
    op.drop_table('oauth_client_states')
    op.drop_index('mcp_assignment_unique_idx', table_name='mcp_server_assignments')
    op.drop_index('mcp_assignment_server_idx', table_name='mcp_server_assignments')
    op.drop_index('mcp_assignment_entity_idx', table_name='mcp_server_assignments')
    op.drop_table('mcp_server_assignments')
    op.drop_index('google_accounts_user_idx', table_name='google_accounts')
    op.drop_index('google_accounts_email_idx', table_name='google_accounts')
    op.drop_index('google_accounts_active_idx', table_name='google_accounts')
    op.drop_table('google_accounts')
    op.drop_index('github_accounts_user_idx', table_name='github_accounts')
    op.drop_index('github_accounts_active_idx', table_name='github_accounts')
    op.drop_table('github_accounts')
    op.drop_table('discord_bot_users')
    op.drop_index(op.f('ix_coding_projects_user_id'), table_name='coding_projects')
    op.drop_index('idx_coding_projects_user', table_name='coding_projects')
    op.drop_index('idx_coding_projects_source', table_name='coding_projects')
    op.drop_index('idx_coding_projects_directory', table_name='coding_projects')
    op.drop_table('coding_projects')
    op.drop_index(op.f('ix_claude_config_snapshots_user_id'), table_name='claude_config_snapshots')
    op.drop_index('idx_snapshots_user', table_name='claude_config_snapshots')
    op.drop_index('idx_snapshots_hash', table_name='claude_config_snapshots')
    op.drop_table('claude_config_snapshots')
    op.drop_index('idx_polls_user_id', table_name='availability_polls')
    op.drop_index('idx_polls_status', table_name='availability_polls')
    op.drop_index('idx_polls_created_at', table_name='availability_polls')
    op.drop_table('availability_polls')
    op.drop_table('api_keys')
    op.drop_table('users')
    op.drop_index('reaction_type_idx', table_name='reaction_pattern')
    op.drop_index('reaction_trigger_idx', table_name='reaction_pattern')
    op.drop_index('reaction_frequency_idx', table_name='reaction_pattern')
    op.drop_table('reaction_pattern')
    op.drop_index('obs_pattern_validity_idx', table_name='observation_pattern')
    op.drop_index('obs_pattern_type_idx', table_name='observation_pattern')
    op.drop_index('obs_pattern_confidence_idx', table_name='observation_pattern')
    op.drop_table('observation_pattern')
    op.drop_table('oauth_client')
    op.drop_index('idx_metric_events_type_name', table_name='metric_events')
    op.drop_index('idx_metric_events_timestamp_type', table_name='metric_events')
    op.drop_index('idx_metric_events_timestamp', table_name='metric_events')
    op.drop_table('metric_events')
    op.drop_index('mcp_state_idx', table_name='mcp_servers')
    op.drop_table('mcp_servers')
    op.drop_table('google_oauth_config')
    op.drop_table('discord_bots')
    op.drop_index('conv_metrics_session_idx', table_name='conversation_metrics')
    op.drop_index('conv_metrics_depth_idx', table_name='conversation_metrics')
    op.drop_index('conv_metrics_breakthrough_idx', table_name='conversation_metrics')
    op.drop_table('conversation_metrics')
    op.drop_index('book_title_idx', table_name='book')
    op.drop_index('book_isbn_idx', table_name='book')
    op.drop_index('book_author_idx', table_name='book')
    op.drop_table('book')
    op.drop_index('belief_cluster_name_idx', table_name='belief_cluster')
    op.drop_index('belief_cluster_consistency_idx', table_name='belief_cluster')
    op.drop_table('belief_cluster')
    # ### end Alembic commands ### 